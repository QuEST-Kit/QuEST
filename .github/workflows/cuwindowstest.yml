name: Windows CUDA (via cuda-toolkit) test

# get this started again real quick
on:
  push:
    branches:
      - ci-compiling
  pull_request:
    branches:
      - ci-compiling

jobs:

  # test only compilation succeeds (no execution)
  build-test:
    name: Testing compilation
    runs-on: windows-latest

    # perform the job
    steps:
      - name: Get QuEST
        uses: actions/checkout@v4

      # obtain CUDA, including "visual_studio_integration" for MSVC
      - name: Obtain CUDA
        uses: Jimver/cuda-toolkit@v0.2.21
        id: cuda-toolkit
        with:
          method: network
          sub-packages: '["nvcc", "cudart", "thrust", "visual_studio_integration"]'

      # invoke cmake, disabling LTO (it duplicates symbols with CUDA+MPI)
      - name: Configure CMake
        run: >
          cmake -B build
          -DCMAKE_CXX_FLAGS="-fno-lto ${CMAKE_CXX_FLAGS}"
          -DENABLE_CUDA=ON
          -DCMAKE_CUDA_ARCHITECTURES=70
        
      - name: Compile
        run: >
          cmake --build build --verbose
