<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Quantum Exact Simulation Toolkit: QuEST_cpu_distributed.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>QuEST_cpu_distributed.c</h1><a href="QuEST__cpu__distributed_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// Distributed under MIT licence. See https://github.com/aniabrown/QuEST/blob/master/LICENCE.txt for details </span>
<a name="l00002"></a>00002 
<a name="l00008"></a>00008 <span class="preprocessor"># include &quot;../QuEST.h&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor"># include &quot;../QuEST_internal.h&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor"># include &quot;../QuEST_precision.h&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor"># include &quot;../mt19937ar.h&quot;</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor"># include &quot;<a class="code" href="QuEST__cpu__internal_8h.html" title="Internal functions used to implement the pure backend in .">QuEST_cpu_internal.h</a>&quot;</span>
<a name="l00014"></a>00014 
<a name="l00015"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ad3d8a3bd0c0b677acef144f2c2ef6d73">00015</a> <span class="preprocessor">#define _BSD_SOURCE</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor"># include &lt;unistd.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor"># include &lt;mpi.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor"># include &lt;stdlib.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor"># include &lt;stdio.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor"># include &lt;string.h&gt;</span>    <span class="comment">// for memcpy</span>
<a name="l00021"></a>00021 <span class="preprocessor"># include &lt;math.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor"># include &lt;time.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor"># include &lt;sys/types.h&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor"># ifdef _OPENMP</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor"># include &lt;omp.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor"># endif</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00035"></a>00035 <span class="comment">// TODO -- This should not also be multiply defined in QuEST_cpu.c -- move to a helper functions file</span>
<a name="l00036"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a100463f6ec212c76a5fad99579000505">00036</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a100463f6ec212c76a5fad99579000505" title="Get the value of the bit at a particular index in a number.">extractBit</a> (<span class="keyword">const</span> <span class="keywordtype">int</span> locationOfBitFromRight, <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> theEncodedNumber)
<a name="l00037"></a>00037 {
<a name="l00038"></a>00038     <span class="keywordflow">return</span> (theEncodedNumber &amp; ( 1LL &lt;&lt; locationOfBitFromRight )) &gt;&gt; locationOfBitFromRight;
<a name="l00039"></a>00039 }
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a7ebd3198a198f4cd20840f64fd8b84d0">00041</a> <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> <a class="code" href="QuEST__internal_8h.html#a7ebd3198a198f4cd20840f64fd8b84d0" title="Terrible code which unnecessarily individually computes and sums the real and imaginary...">statevec_calcInnerProduct</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> bra, <a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> ket) {
<a name="l00042"></a>00042     
<a name="l00043"></a>00043     <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> localInnerProd = <a class="code" href="QuEST__cpu_8c.html#a6fbb3b693f25dde1e9e3dc87dc1984f7">statevec_calcInnerProductLocal</a>(bra, ket);
<a name="l00044"></a>00044     <span class="keywordflow">if</span> (bra.<a class="code" href="structQureg.html#aa3deb7163aab90a61e755a1f200f5413" title="Number of chunks the state vector is broken up into -- the number of MPI processes...">numChunks</a> == 1)
<a name="l00045"></a>00045         <span class="keywordflow">return</span> localInnerProd;
<a name="l00046"></a>00046     
<a name="l00047"></a>00047     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> localReal = localInnerProd.<a class="code" href="structComplex.html#ab5b2e2eca02131fc74b289a83636cbe3">real</a>;
<a name="l00048"></a>00048     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> localImag = localInnerProd.<a class="code" href="structComplex.html#a84f5439aad0ef495efdd3b4c1c02d27e">imag</a>;
<a name="l00049"></a>00049     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> globalReal, globalImag;
<a name="l00050"></a>00050     MPI_Allreduce(&amp;localReal, &amp;globalReal, 1, MPI_QuEST_REAL, MPI_SUM, MPI_COMM_WORLD);
<a name="l00051"></a>00051     MPI_Allreduce(&amp;localImag, &amp;globalImag, 1, MPI_QuEST_REAL, MPI_SUM, MPI_COMM_WORLD);
<a name="l00052"></a>00052     
<a name="l00053"></a>00053     <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> globalInnerProd;
<a name="l00054"></a>00054     globalInnerProd.<a class="code" href="structComplex.html#ab5b2e2eca02131fc74b289a83636cbe3">real</a> = globalReal;
<a name="l00055"></a>00055     globalInnerProd.<a class="code" href="structComplex.html#a84f5439aad0ef495efdd3b4c1c02d27e">imag</a> = globalImag;
<a name="l00056"></a>00056     <span class="keywordflow">return</span> globalInnerProd;
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a6153547f245c05874161a105e9a2f02c">00059</a> <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="QuEST__internal_8h.html#a6153547f245c05874161a105e9a2f02c">densmatr_calcTotalProb</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg) {
<a name="l00060"></a>00060         
<a name="l00061"></a>00061         <span class="comment">// computes the trace by summing every element (&quot;diag&quot;) with global index (2^n + 1)i for i in [0, 2^n-1]</span>
<a name="l00062"></a>00062         
<a name="l00063"></a>00063         <span class="comment">// computes first local index containing a diagonal element</span>
<a name="l00064"></a>00064         <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> diagSpacing = 1LL + (1LL &lt;&lt; qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00065"></a>00065     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numPrevDiags = (qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>&gt;0)? 1+(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>*qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>)/diagSpacing : 0;
<a name="l00066"></a>00066         <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> globalIndNextDiag = diagSpacing * numPrevDiags;
<a name="l00067"></a>00067         <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> localIndNextDiag = globalIndNextDiag % qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>;
<a name="l00068"></a>00068         <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> index;
<a name="l00069"></a>00069         
<a name="l00070"></a>00070         <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> rankTotal = 0;
<a name="l00071"></a>00071         <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="README_8md.html#a003dc5701d53a819228f5417a8089139">y</a>, t, c;
<a name="l00072"></a>00072         c = 0;
<a name="l00073"></a>00073         
<a name="l00074"></a>00074         <span class="comment">// iterates every local diagonal</span>
<a name="l00075"></a>00075         <span class="keywordflow">for</span> (index=localIndNextDiag; index &lt; qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>; index += diagSpacing) {
<a name="l00076"></a>00076                 
<a name="l00077"></a>00077                 <span class="comment">// Kahan summation - brackets are important</span>
<a name="l00078"></a>00078                 y = qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.real[index] - c;
<a name="l00079"></a>00079                 t = rankTotal + y;
<a name="l00080"></a>00080                 c = ( t - rankTotal ) - y;
<a name="l00081"></a>00081                 rankTotal = t;
<a name="l00082"></a>00082         }
<a name="l00083"></a>00083         
<a name="l00084"></a>00084         <span class="comment">// combine each node&apos;s sum of diagonals</span>
<a name="l00085"></a>00085         <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> globalTotal;
<a name="l00086"></a>00086         <span class="keywordflow">if</span> (qureg.<a class="code" href="structQureg.html#aa3deb7163aab90a61e755a1f200f5413" title="Number of chunks the state vector is broken up into -- the number of MPI processes...">numChunks</a> &gt; 1)
<a name="l00087"></a>00087                 MPI_Allreduce(&amp;rankTotal, &amp;globalTotal, 1, MPI_QuEST_REAL, MPI_SUM, MPI_COMM_WORLD);
<a name="l00088"></a>00088         <span class="keywordflow">else</span>
<a name="l00089"></a>00089                 globalTotal = rankTotal;
<a name="l00090"></a>00090         
<a name="l00091"></a>00091         <span class="keywordflow">return</span> globalTotal;
<a name="l00092"></a>00092 }
<a name="l00093"></a>00093 
<a name="l00094"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ad65ad1b5ea6f30b0c6b4ffda96e1a8e6">00094</a> <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="QuEST__internal_8h.html#ad65ad1b5ea6f30b0c6b4ffda96e1a8e6">statevec_calcTotalProb</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg){
<a name="l00095"></a>00095     <span class="comment">// Implemented using Kahan summation for greater accuracy at a slight floating</span>
<a name="l00096"></a>00096     <span class="comment">//   point operation overhead. For more details see https://en.wikipedia.org/wiki/Kahan_summation_algorithm</span>
<a name="l00097"></a>00097     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> pTotal=0; 
<a name="l00098"></a>00098     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="README_8md.html#a003dc5701d53a819228f5417a8089139">y</a>, t, c;
<a name="l00099"></a>00099     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> allRankTotals=0;
<a name="l00100"></a>00100     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> index;
<a name="l00101"></a>00101     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numAmpsPerRank = qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>;
<a name="l00102"></a>00102     c = 0.0;
<a name="l00103"></a>00103     <span class="keywordflow">for</span> (index=0; index&lt;numAmpsPerRank; index++){ 
<a name="l00104"></a>00104         <span class="comment">// Perform pTotal+=qureg.stateVec.real[index]*qureg.stateVec.real[index]; by Kahan</span>
<a name="l00105"></a>00105         y = qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.real[index]*qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.real[index] - c;
<a name="l00106"></a>00106         t = pTotal + y;
<a name="l00107"></a>00107         <span class="comment">// Don&apos;t change the bracketing on the following line</span>
<a name="l00108"></a>00108         c = ( t - pTotal ) - y;
<a name="l00109"></a>00109         pTotal = t;
<a name="l00110"></a>00110         <span class="comment">// Perform pTotal+=qureg.stateVec.imag[index]*qureg.stateVec.imag[index]; by Kahan</span>
<a name="l00111"></a>00111         y = qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.imag[index]*qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.imag[index] - c;
<a name="l00112"></a>00112         t = pTotal + y;
<a name="l00113"></a>00113         <span class="comment">// Don&apos;t change the bracketing on the following line</span>
<a name="l00114"></a>00114         c = ( t - pTotal ) - y;
<a name="l00115"></a>00115         pTotal = t;
<a name="l00116"></a>00116     } 
<a name="l00117"></a>00117     <span class="keywordflow">if</span> (qureg.<a class="code" href="structQureg.html#aa3deb7163aab90a61e755a1f200f5413" title="Number of chunks the state vector is broken up into -- the number of MPI processes...">numChunks</a>&gt;1)
<a name="l00118"></a>00118                 MPI_Allreduce(&amp;pTotal, &amp;allRankTotals, 1, MPI_QuEST_REAL, MPI_SUM, MPI_COMM_WORLD);
<a name="l00119"></a>00119     <span class="keywordflow">else</span> 
<a name="l00120"></a>00120                 allRankTotals=pTotal;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="keywordflow">return</span> allRankTotals;
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#af0ea25f00987af4c53f17c9cca62ab41" title="Find chunks to skip when calculating probability of qubit being zero.">isChunkToSkipInFindPZero</a>(<span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> measureQubit);
<a name="l00127"></a>00127 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(<span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit);
<a name="l00128"></a>00128 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#aa3c2d644a2be7f0d3aa9f757527d306f" title="fix -- do with masking instead">chunkIsUpperInOuterBlock</a>(<span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit, <span class="keywordtype">int</span> numQubits);
<a name="l00129"></a>00129 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="QuEST__cpu__distributed_8c.html#adb4b0373425b282abed27742d0ce0872" title="Get rotation values for a given chunk.">getRotAngle</a>(<span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> *rot1, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> *rot2, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> alpha, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> beta);
<a name="l00130"></a>00130 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(<span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>, <span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit);
<a name="l00131"></a>00131 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#ae66dc6569c6e4008c33d6739db422c08">getChunkOuterBlockPairId</a>(<span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>, <span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit,        <span class="keywordtype">int</span> numQubits);
<a name="l00132"></a>00132 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(<span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit);
<a name="l00133"></a>00133 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a28be36627b2dd9a0da63dd6f60121b06">getChunkIdFromIndex</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> index);
<a name="l00134"></a>00134 
<a name="l00135"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a8ba2c3388dd64d9348c3b091852d36d4">00135</a> <a class="code" href="structQuESTEnv.html" title="Information about the environment the program is running in.">QuESTEnv</a> <a class="code" href="QuEST_8h.html#a8ba2c3388dd64d9348c3b091852d36d4" title="Create the QuEST execution environment.">createQuESTEnv</a>(<span class="keywordtype">void</span>) {
<a name="l00136"></a>00136     
<a name="l00137"></a>00137     <a class="code" href="structQuESTEnv.html" title="Information about the environment the program is running in.">QuESTEnv</a> env;
<a name="l00138"></a>00138     
<a name="l00139"></a>00139     <span class="comment">// init MPI environment</span>
<a name="l00140"></a>00140     <span class="keywordtype">int</span> rank, numRanks, initialized;
<a name="l00141"></a>00141     MPI_Initialized(&amp;initialized);
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (!initialized){
<a name="l00143"></a>00143         MPI_Init(NULL, NULL);
<a name="l00144"></a>00144         MPI_Comm_size(MPI_COMM_WORLD, &amp;numRanks);
<a name="l00145"></a>00145         MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         env.<a class="code" href="structQuESTEnv.html#aa648bb336cf8598467cb62db00b9cee8">rank</a>=rank;
<a name="l00148"></a>00148         env.<a class="code" href="structQuESTEnv.html#af22aacd7c9905accae28484785c193b4">numRanks</a>=numRanks;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     } <span class="keywordflow">else</span> {
<a name="l00151"></a>00151         
<a name="l00152"></a>00152         printf(<span class="stringliteral">&quot;ERROR: Trying to initialize QuESTEnv multiple times. Ignoring...\n&quot;</span>);
<a name="l00153"></a>00153         
<a name="l00154"></a>00154         <span class="comment">// ensure env is initialised anyway, so the compiler is happy</span>
<a name="l00155"></a>00155         MPI_Comm_size(MPI_COMM_WORLD, &amp;numRanks);
<a name="l00156"></a>00156         MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);
<a name="l00157"></a>00157         env.<a class="code" href="structQuESTEnv.html#aa648bb336cf8598467cb62db00b9cee8">rank</a>=rank;
<a name="l00158"></a>00158         env.<a class="code" href="structQuESTEnv.html#af22aacd7c9905accae28484785c193b4">numRanks</a>=numRanks;
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160     
<a name="l00161"></a>00161         <a class="code" href="QuEST_8h.html#aa8437ef3bf135231e2916e64dde1c94e" title="Seed the Mersenne Twister used for random number generation in the QuEST environment...">seedQuESTDefault</a>();
<a name="l00162"></a>00162     
<a name="l00163"></a>00163     <span class="keywordflow">return</span> env;
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00166"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a8d31fe2d1ad4d01e2a1f5f6b8bc15b77">00166</a> <span class="keywordtype">void</span> <a class="code" href="QuEST_8h.html#a8d31fe2d1ad4d01e2a1f5f6b8bc15b77" title="Guarantees that all code up to the given point has been executed on all nodes (if...">syncQuESTEnv</a>(<a class="code" href="structQuESTEnv.html" title="Information about the environment the program is running in.">QuESTEnv</a> env){
<a name="l00167"></a>00167     MPI_Barrier(MPI_COMM_WORLD);
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ac7e38d768a1bd79019f88cc1e6295092">00170</a> <span class="keywordtype">int</span> <a class="code" href="QuEST_8h.html#ac7e38d768a1bd79019f88cc1e6295092" title="Performs a logical AND on all successCodes held by all processes.">syncQuESTSuccess</a>(<span class="keywordtype">int</span> successCode){
<a name="l00171"></a>00171     <span class="keywordtype">int</span> totalSuccess;
<a name="l00172"></a>00172     MPI_Allreduce(&amp;successCode, &amp;totalSuccess, 1, MPI_INT, MPI_LAND, MPI_COMM_WORLD);
<a name="l00173"></a>00173     <span class="keywordflow">return</span> totalSuccess;
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a><a class="code" href="QuEST__cpu__distributed_8c.html#aeff624226629d7063a8a776958a4f991">00176</a> <span class="keywordtype">void</span> <a class="code" href="QuEST_8h.html#aeff624226629d7063a8a776958a4f991" title="Destroy the QuEST environment.">destroyQuESTEnv</a>(<a class="code" href="structQuESTEnv.html" title="Information about the environment the program is running in.">QuESTEnv</a> env){
<a name="l00177"></a>00177     <span class="keywordtype">int</span> finalized;
<a name="l00178"></a>00178     MPI_Finalized(&amp;finalized);
<a name="l00179"></a>00179     <span class="keywordflow">if</span> (!finalized) MPI_Finalize();
<a name="l00180"></a>00180     <span class="keywordflow">else</span> printf(<span class="stringliteral">&quot;ERROR: Trying to close QuESTEnv multiple times. Ignoring\n&quot;</span>);
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="QuEST__cpu__distributed_8c.html#af8a14ae79c3fb2c0b5f6255cc37bebf9">00183</a> <span class="keywordtype">void</span> <a class="code" href="QuEST_8h.html#af8a14ae79c3fb2c0b5f6255cc37bebf9" title="Report information about the QuEST environment.">reportQuESTEnv</a>(<a class="code" href="structQuESTEnv.html" title="Information about the environment the program is running in.">QuESTEnv</a> env){
<a name="l00184"></a>00184     <span class="keywordflow">if</span> (env.<a class="code" href="structQuESTEnv.html#aa648bb336cf8598467cb62db00b9cee8">rank</a>==0){
<a name="l00185"></a>00185         printf(<span class="stringliteral">&quot;EXECUTION ENVIRONMENT:\n&quot;</span>); 
<a name="l00186"></a>00186         printf(<span class="stringliteral">&quot;Running distributed (MPI) version\n&quot;</span>);
<a name="l00187"></a>00187         printf(<span class="stringliteral">&quot;Number of ranks is %d\n&quot;</span>, env.<a class="code" href="structQuESTEnv.html#af22aacd7c9905accae28484785c193b4">numRanks</a>);
<a name="l00188"></a>00188 <span class="preprocessor"># ifdef _OPENMP</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;OpenMP enabled\n&quot;</span>);
<a name="l00190"></a>00190         printf(<span class="stringliteral">&quot;Number of threads available is %d\n&quot;</span>, omp_get_max_threads());
<a name="l00191"></a>00191 <span class="preprocessor"># else</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;OpenMP disabled\n&quot;</span>);
<a name="l00193"></a>00193 <span class="preprocessor"># endif </span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;Precision: size of qreal is %ld bytes\n&quot;</span>, <span class="keyword">sizeof</span>(<a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a>) );
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a62da5b58d8ce84e6f4d24be1b872294e">00198</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__debug_8h.html#a62da5b58d8ce84e6f4d24be1b872294e" title="Report a list of CPU hostnames and the rank that is running on each if running with...">reportNodeList</a>(<a class="code" href="structQuESTEnv.html" title="Information about the environment the program is running in.">QuESTEnv</a> env){
<a name="l00199"></a>00199     <span class="keywordtype">char</span> hostName[256];
<a name="l00200"></a>00200     gethostname(hostName, 255);
<a name="l00201"></a>00201     printf(<span class="stringliteral">&quot;hostname on rank %d: %s\n&quot;</span>, env.<a class="code" href="structQuESTEnv.html#aa648bb336cf8598467cb62db00b9cee8">rank</a>, hostName);
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a28be36627b2dd9a0da63dd6f60121b06">00204</a> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a28be36627b2dd9a0da63dd6f60121b06">getChunkIdFromIndex</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> index){
<a name="l00205"></a>00205     <span class="keywordflow">return</span> index/qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>; <span class="comment">// this is numAmpsPerChunk</span>
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="QuEST__cpu__distributed_8c.html#abc9a9ef4344c7faaaf28ac25c76649b9">00208</a> <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="QuEST__internal_8h.html#abc9a9ef4344c7faaaf28ac25c76649b9">statevec_getRealAmp</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> index){
<a name="l00209"></a>00209     <span class="keywordtype">int</span> chunkId = <a class="code" href="QuEST__cpu__distributed_8c.html#a28be36627b2dd9a0da63dd6f60121b06">getChunkIdFromIndex</a>(qureg, index);
<a name="l00210"></a>00210     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> el; 
<a name="l00211"></a>00211     <span class="keywordflow">if</span> (qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>==chunkId){
<a name="l00212"></a>00212         el = qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.real[index-chunkId*qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>];
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214     MPI_Bcast(&amp;el, 1, MPI_QuEST_REAL, chunkId, MPI_COMM_WORLD);
<a name="l00215"></a>00215     <span class="keywordflow">return</span> el; 
<a name="l00216"></a>00216 } 
<a name="l00217"></a>00217 
<a name="l00218"></a><a class="code" href="QuEST__cpu__distributed_8c.html#abd509244d57657e148e4084c5ab5d28f">00218</a> <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="QuEST__internal_8h.html#abd509244d57657e148e4084c5ab5d28f">statevec_getImagAmp</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> index){
<a name="l00219"></a>00219     <span class="keywordtype">int</span> chunkId = <a class="code" href="QuEST__cpu__distributed_8c.html#a28be36627b2dd9a0da63dd6f60121b06">getChunkIdFromIndex</a>(qureg, index);
<a name="l00220"></a>00220     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> el; 
<a name="l00221"></a>00221     <span class="keywordflow">if</span> (qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>==chunkId){
<a name="l00222"></a>00222         el = qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.imag[index-chunkId*qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>];
<a name="l00223"></a>00223     }
<a name="l00224"></a>00224     MPI_Bcast(&amp;el, 1, MPI_QuEST_REAL, chunkId, MPI_COMM_WORLD);
<a name="l00225"></a>00225     <span class="keywordflow">return</span> el; 
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d">00237</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(<span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit)
<a name="l00238"></a>00238 {       
<a name="l00239"></a>00239     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeHalfBlock = 1LL &lt;&lt; (targetQubit);
<a name="l00240"></a>00240     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeBlock = sizeHalfBlock*2;
<a name="l00241"></a>00241     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> posInBlock = (chunkId*chunkSize) % sizeBlock;
<a name="l00242"></a>00242     <span class="keywordflow">return</span> posInBlock&lt;sizeHalfBlock;
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00246"></a><a class="code" href="QuEST__cpu__distributed_8c.html#aa3c2d644a2be7f0d3aa9f757527d306f">00246</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#aa3c2d644a2be7f0d3aa9f757527d306f" title="fix -- do with masking instead">chunkIsUpperInOuterBlock</a>(<span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit, <span class="keywordtype">int</span> numQubits)
<a name="l00247"></a>00247 {       
<a name="l00248"></a>00248     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeOuterHalfBlock = 1LL &lt;&lt; (targetQubit+numQubits);
<a name="l00249"></a>00249     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeOuterBlock = sizeOuterHalfBlock*2;
<a name="l00250"></a>00250     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> posInBlock = (chunkId*chunkSize) % sizeOuterBlock;
<a name="l00251"></a>00251     <span class="keywordflow">return</span> posInBlock&lt;sizeOuterHalfBlock;
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00268"></a><a class="code" href="QuEST__cpu__distributed_8c.html#adb4b0373425b282abed27742d0ce0872">00268</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="QuEST__cpu__distributed_8c.html#adb4b0373425b282abed27742d0ce0872" title="Get rotation values for a given chunk.">getRotAngle</a>(<span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> *rot1, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> *rot2, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> alpha, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> beta)
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270     <span class="keywordflow">if</span> (chunkIsUpper){
<a name="l00271"></a>00271         *rot1=alpha;
<a name="l00272"></a>00272         rot2-&gt;<a class="code" href="structComplex.html#ab5b2e2eca02131fc74b289a83636cbe3">real</a>=-beta.<a class="code" href="structComplex.html#ab5b2e2eca02131fc74b289a83636cbe3">real</a>;
<a name="l00273"></a>00273         rot2-&gt;<a class="code" href="structComplex.html#a84f5439aad0ef495efdd3b4c1c02d27e">imag</a>=-beta.<a class="code" href="structComplex.html#a84f5439aad0ef495efdd3b4c1c02d27e">imag</a>;
<a name="l00274"></a>00274     } <span class="keywordflow">else</span> {
<a name="l00275"></a>00275         *rot1=beta;
<a name="l00276"></a>00276         *rot2=alpha;
<a name="l00277"></a>00277     }
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00293"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a5c9b2f129bdffaaba9857f6eddecbb17">00293</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a5c9b2f129bdffaaba9857f6eddecbb17" title="Get rotation values for a given chunk given a unitary matrix.">getRotAngleFromUnitaryMatrix</a>(<span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> *rot1, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> *rot2, <a class="code" href="structComplexMatrix2.html" title="Represents a 2x2 matrix of complex numbers.">ComplexMatrix2</a> <a class="code" href="README_8md.html#a5d1c311241dc8d8ffa4badf059977dc5">u</a>)
<a name="l00294"></a>00294 {
<a name="l00295"></a>00295     <span class="keywordflow">if</span> (chunkIsUpper){
<a name="l00296"></a>00296         *rot1=u.<a class="code" href="structComplexMatrix2.html#ae72b4458233b077a636beee1892e81ff">r0c0</a>;
<a name="l00297"></a>00297         *rot2=u.<a class="code" href="structComplexMatrix2.html#a0f3932f055a8b05cef361bce25d51172">r0c1</a>;
<a name="l00298"></a>00298     } <span class="keywordflow">else</span> {
<a name="l00299"></a>00299         *rot1=u.<a class="code" href="structComplexMatrix2.html#ab98282015ed2065e53fbc9638e2583ab">r1c0</a>;
<a name="l00300"></a>00300         *rot2=u.<a class="code" href="structComplexMatrix2.html#a763007c3070802373549ba0350f83c8a">r1c1</a>;
<a name="l00301"></a>00301     }
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00313"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4">00313</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(<span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>, <span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit)
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeHalfBlock = 1LL &lt;&lt; (targetQubit);
<a name="l00316"></a>00316     <span class="keywordtype">int</span> chunksPerHalfBlock = sizeHalfBlock/chunkSize;
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (chunkIsUpper){
<a name="l00318"></a>00318         <span class="keywordflow">return</span> chunkId + chunksPerHalfBlock;
<a name="l00319"></a>00319     } <span class="keywordflow">else</span> {
<a name="l00320"></a>00320         <span class="keywordflow">return</span> chunkId - chunksPerHalfBlock;
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ae66dc6569c6e4008c33d6739db422c08">00324</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#ae66dc6569c6e4008c33d6739db422c08">getChunkOuterBlockPairId</a>(<span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>, <span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit, <span class="keywordtype">int</span> numQubits)
<a name="l00325"></a>00325 {
<a name="l00326"></a>00326     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeOuterHalfBlock = 1LL &lt;&lt; (targetQubit+numQubits);
<a name="l00327"></a>00327     <span class="keywordtype">int</span> chunksPerOuterHalfBlock = sizeOuterHalfBlock/chunkSize;
<a name="l00328"></a>00328     <span class="keywordflow">if</span> (chunkIsUpper){
<a name="l00329"></a>00329         <span class="keywordflow">return</span> chunkId + chunksPerOuterHalfBlock;
<a name="l00330"></a>00330     } <span class="keywordflow">else</span> {
<a name="l00331"></a>00331         <span class="keywordflow">return</span> chunkId - chunksPerOuterHalfBlock;
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00335"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ab1ec7f241b68b079c8e316d190af49ce">00335</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#ab1ec7f241b68b079c8e316d190af49ce">getChunkOuterBlockPairIdForPart3</a>(<span class="keywordtype">int</span> chunkIsUpperSmallerQubit, <span class="keywordtype">int</span> chunkIsUpperBiggerQubit, <span class="keywordtype">int</span> chunkId, 
<a name="l00336"></a>00336         <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> smallerQubit, <span class="keywordtype">int</span> biggerQubit, <span class="keywordtype">int</span> numQubits)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeOuterHalfBlockBiggerQubit = 1LL &lt;&lt; (biggerQubit+numQubits);
<a name="l00339"></a>00339     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeOuterHalfBlockSmallerQubit = 1LL &lt;&lt; (smallerQubit+numQubits);
<a name="l00340"></a>00340     <span class="keywordtype">int</span> chunksPerOuterHalfBlockSmallerQubit = sizeOuterHalfBlockSmallerQubit/chunkSize;
<a name="l00341"></a>00341     <span class="keywordtype">int</span> chunksPerOuterHalfBlockBiggerQubit = sizeOuterHalfBlockBiggerQubit/chunkSize;
<a name="l00342"></a>00342     <span class="keywordtype">int</span> rank;
<a name="l00343"></a>00343     <span class="keywordflow">if</span> (chunkIsUpperBiggerQubit){
<a name="l00344"></a>00344         rank = chunkId + chunksPerOuterHalfBlockBiggerQubit;
<a name="l00345"></a>00345     } <span class="keywordflow">else</span> {
<a name="l00346"></a>00346         rank = chunkId - chunksPerOuterHalfBlockBiggerQubit;
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="keywordflow">if</span> (chunkIsUpperSmallerQubit){
<a name="l00350"></a>00350         rank = rank + chunksPerOuterHalfBlockSmallerQubit;
<a name="l00351"></a>00351     } <span class="keywordflow">else</span> {
<a name="l00352"></a>00352         rank = rank - chunksPerOuterHalfBlockSmallerQubit;
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="keywordflow">return</span> rank;
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00365"></a>00365 
<a name="l00366"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790">00366</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(<span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> targetQubit)
<a name="l00367"></a>00367 {
<a name="l00368"></a>00368     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeHalfBlock = 1LL &lt;&lt; (targetQubit);
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (chunkSize &gt; sizeHalfBlock) <span class="keywordflow">return</span> 1;
<a name="l00370"></a>00370     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 
<a name="l00373"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a076fe6125da4d6037b8bc4d912df4015">00373</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a076fe6125da4d6037b8bc4d912df4015">densityMatrixBlockFitsInChunk</a>(<span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> numQubits, <span class="keywordtype">int</span> targetQubit) {
<a name="l00374"></a>00374     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeOuterHalfBlock = 1LL &lt;&lt; (targetQubit+numQubits);
<a name="l00375"></a>00375     <span class="keywordflow">if</span> (chunkSize &gt; sizeOuterHalfBlock) <span class="keywordflow">return</span> 1;
<a name="l00376"></a>00376     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00379"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a95af772d87c461fc8abfd6d47b752ac2">00379</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a95af772d87c461fc8abfd6d47b752ac2">copyVecIntoMatrixPairState</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> matr, <a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> vec) {
<a name="l00380"></a>00380     
<a name="l00381"></a>00381     <span class="comment">// copy this state&apos;s pure state section into this qureg&apos;s pairState</span>
<a name="l00382"></a>00382     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numLocalAmps = vec.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>;
<a name="l00383"></a>00383     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> myOffset = vec.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a> * numLocalAmps;
<a name="l00384"></a>00384     memcpy(&amp;matr.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real[myOffset], vec.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.real, numLocalAmps * <span class="keyword">sizeof</span>(<a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a>) );
<a name="l00385"></a>00385     memcpy(&amp;matr.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag[myOffset], vec.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.imag, numLocalAmps * <span class="keyword">sizeof</span>(<a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a>) );
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     <span class="comment">// work out how many messages needed to send vec chunks (2GB limit)</span>
<a name="l00388"></a>00388     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> maxMsgSize = MPI_MAX_AMPS_IN_MSG;
<a name="l00389"></a>00389     <span class="keywordflow">if</span> (numLocalAmps &lt; maxMsgSize) 
<a name="l00390"></a>00390         maxMsgSize = numLocalAmps;
<a name="l00391"></a>00391     <span class="comment">// safely assume MPI_MAX... = 2^n, so division always exact:</span>
<a name="l00392"></a>00392     <span class="keywordtype">int</span> numMsgs = numLocalAmps / maxMsgSize;
<a name="l00393"></a>00393     
<a name="l00394"></a>00394     <span class="comment">// every node gets a turn at being the broadcaster</span>
<a name="l00395"></a>00395     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> broadcaster=0; broadcaster &lt; vec.<a class="code" href="structQureg.html#aa3deb7163aab90a61e755a1f200f5413" title="Number of chunks the state vector is broken up into -- the number of MPI processes...">numChunks</a>; broadcaster++) {
<a name="l00396"></a>00396         
<a name="l00397"></a>00397         <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> otherOffset = broadcaster * numLocalAmps;
<a name="l00398"></a>00398     
<a name="l00399"></a>00399         <span class="comment">// every node sends a slice of qureg&apos;s pairState to every other</span>
<a name="l00400"></a>00400         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt; numMsgs; i++) {
<a name="l00401"></a>00401     
<a name="l00402"></a>00402             <span class="comment">// by sending that slice in further slices (due to bandwidth limit)</span>
<a name="l00403"></a>00403             MPI_Bcast(
<a name="l00404"></a>00404                 &amp;matr.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real[otherOffset + i*maxMsgSize], 
<a name="l00405"></a>00405                 maxMsgSize,  MPI_QuEST_REAL, broadcaster, MPI_COMM_WORLD);
<a name="l00406"></a>00406             MPI_Bcast(
<a name="l00407"></a>00407                 &amp;matr.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag[otherOffset + i*maxMsgSize], 
<a name="l00408"></a>00408                 maxMsgSize,  MPI_QuEST_REAL, broadcaster, MPI_COMM_WORLD);
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00413"></a><a class="code" href="QuEST__cpu__distributed_8c.html#aa6c3f86010ad398f42b0577ea3bb5bcf">00413</a> <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="QuEST__internal_8h.html#aa6c3f86010ad398f42b0577ea3bb5bcf">densmatr_calcFidelity</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> pureState) {
<a name="l00414"></a>00414     
<a name="l00415"></a>00415     <span class="comment">// set qureg&apos;s pairState is to be the full pureState (on every node)</span>
<a name="l00416"></a>00416     <a class="code" href="QuEST__cpu__distributed_8c.html#a95af772d87c461fc8abfd6d47b752ac2">copyVecIntoMatrixPairState</a>(qureg, pureState);
<a name="l00417"></a>00417  
<a name="l00418"></a>00418     <span class="comment">// collect calcFidelityLocal by every machine</span>
<a name="l00419"></a>00419     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> localSum = <a class="code" href="QuEST__cpu_8c.html#a7772f97cb4d92a9825bf3b7c82c3230c" title="computes a few dens-columns-worth of (vec^*T) dens * vec">densmatr_calcFidelityLocal</a>(qureg, pureState);
<a name="l00420"></a>00420     
<a name="l00421"></a>00421     <span class="comment">// sum each localSum</span>
<a name="l00422"></a>00422     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> globalSum;
<a name="l00423"></a>00423     MPI_Allreduce(&amp;localSum, &amp;globalSum, 1, MPI_QuEST_REAL, MPI_SUM, MPI_COMM_WORLD);
<a name="l00424"></a>00424     
<a name="l00425"></a>00425     <span class="keywordflow">return</span> globalSum;
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ae5ad68d054875913d0f7ec654840a9ec">00428</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#ae5ad68d054875913d0f7ec654840a9ec">densmatr_initPureState</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> targetQureg, <a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> copyQureg) {
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     <span class="keywordflow">if</span> (targetQureg.<a class="code" href="structQureg.html#aa3deb7163aab90a61e755a1f200f5413" title="Number of chunks the state vector is broken up into -- the number of MPI processes...">numChunks</a>==1){
<a name="l00431"></a>00431         <span class="comment">// local version</span>
<a name="l00432"></a>00432         <span class="comment">// save pointers to qureg&apos;s pair state</span>
<a name="l00433"></a>00433         <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a>* quregPairRePtr = targetQureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real;
<a name="l00434"></a>00434         <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a>* quregPairImPtr = targetQureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="comment">// populate qureg pair state with pure state (by repointing)</span>
<a name="l00437"></a>00437         targetQureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real = copyQureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.real;
<a name="l00438"></a>00438         targetQureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag = copyQureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.imag;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440         <span class="comment">// populate density matrix via it&apos;s pairState</span>
<a name="l00441"></a>00441         <a class="code" href="QuEST__cpu_8c.html#a1b36518c8fbbc3a5084bb4ad1fb05ea5">densmatr_initPureStateLocal</a>(targetQureg, copyQureg);
<a name="l00442"></a>00442 
<a name="l00443"></a>00443         <span class="comment">// restore pointers</span>
<a name="l00444"></a>00444         targetQureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real = quregPairRePtr;
<a name="l00445"></a>00445         targetQureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag = quregPairImPtr;
<a name="l00446"></a>00446     } <span class="keywordflow">else</span> {
<a name="l00447"></a>00447         <span class="comment">// set qureg&apos;s pairState is to be the full pure state (on every node)</span>
<a name="l00448"></a>00448         <a class="code" href="QuEST__cpu__distributed_8c.html#a95af772d87c461fc8abfd6d47b752ac2">copyVecIntoMatrixPairState</a>(targetQureg, copyQureg);
<a name="l00449"></a>00449         
<a name="l00450"></a>00450         <span class="comment">// update every density matrix chunk using pairState</span>
<a name="l00451"></a>00451         <a class="code" href="QuEST__cpu_8c.html#a1b36518c8fbbc3a5084bb4ad1fb05ea5">densmatr_initPureStateLocal</a>(targetQureg, copyQureg);
<a name="l00452"></a>00452     }
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 
<a name="l00457"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">00457</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keywordtype">int</span> pairRank){
<a name="l00458"></a>00458     <span class="comment">// MPI send/receive vars</span>
<a name="l00459"></a>00459     <span class="keywordtype">int</span> TAG=100;
<a name="l00460"></a>00460     MPI_Status status;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="comment">// Multiple messages are required as MPI uses int rather than long long int for count</span>
<a name="l00463"></a>00463     <span class="comment">// For openmpi, messages are further restricted to 2GB in size -- do this for all cases</span>
<a name="l00464"></a>00464     <span class="comment">// to be safe</span>
<a name="l00465"></a>00465     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> maxMessageCount = MPI_MAX_AMPS_IN_MSG;
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a> &lt; maxMessageCount) 
<a name="l00467"></a>00467         maxMessageCount = qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>;
<a name="l00468"></a>00468     
<a name="l00469"></a>00469     <span class="comment">// safely assume MPI_MAX... = 2^n, so division always exact</span>
<a name="l00470"></a>00470     <span class="keywordtype">int</span> numMessages = qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>/maxMessageCount;
<a name="l00471"></a>00471     <span class="keywordtype">int</span> i;
<a name="l00472"></a>00472     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> offset;
<a name="l00473"></a>00473     <span class="comment">// send my state vector to pairRank&apos;s qureg.pairStateVec</span>
<a name="l00474"></a>00474     <span class="comment">// receive pairRank&apos;s state vector into qureg.pairStateVec</span>
<a name="l00475"></a>00475     <span class="keywordflow">for</span> (i=0; i&lt;numMessages; i++){
<a name="l00476"></a>00476         offset = i*maxMessageCount;
<a name="l00477"></a>00477         MPI_Sendrecv(&amp;qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.real[offset], maxMessageCount, MPI_QuEST_REAL, pairRank, TAG,
<a name="l00478"></a>00478                 &amp;qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real[offset], maxMessageCount, MPI_QuEST_REAL,
<a name="l00479"></a>00479                 pairRank, TAG, MPI_COMM_WORLD, &amp;status);
<a name="l00480"></a>00480         <span class="comment">//printf(&quot;rank: %d err: %d\n&quot;, qureg.rank, err);</span>
<a name="l00481"></a>00481         MPI_Sendrecv(&amp;qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.imag[offset], maxMessageCount, MPI_QuEST_REAL, pairRank, TAG,
<a name="l00482"></a>00482                 &amp;qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag[offset], maxMessageCount, MPI_QuEST_REAL,
<a name="l00483"></a>00483                 pairRank, TAG, MPI_COMM_WORLD, &amp;status);
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a37dae401754961c9100b3c0907913c3e">00487</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a37dae401754961c9100b3c0907913c3e">exchangePairStateVectorHalves</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keywordtype">int</span> pairRank){
<a name="l00488"></a>00488     <span class="comment">// MPI send/receive vars</span>
<a name="l00489"></a>00489     <span class="keywordtype">int</span> TAG=100;
<a name="l00490"></a>00490     MPI_Status status;
<a name="l00491"></a>00491     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numAmpsToSend = qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a> &gt;&gt; 1;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="comment">// Multiple messages are required as MPI uses int rather than long long int for count</span>
<a name="l00494"></a>00494     <span class="comment">// For openmpi, messages are further restricted to 2GB in size -- do this for all cases</span>
<a name="l00495"></a>00495     <span class="comment">// to be safe</span>
<a name="l00496"></a>00496     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> maxMessageCount = MPI_MAX_AMPS_IN_MSG;
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (numAmpsToSend &lt; maxMessageCount) 
<a name="l00498"></a>00498         maxMessageCount = numAmpsToSend;
<a name="l00499"></a>00499     
<a name="l00500"></a>00500     <span class="comment">// safely assume MPI_MAX... = 2^n, so division always exact</span>
<a name="l00501"></a>00501     <span class="keywordtype">int</span> numMessages = numAmpsToSend/maxMessageCount;
<a name="l00502"></a>00502     <span class="keywordtype">int</span> i;
<a name="l00503"></a>00503     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> offset;
<a name="l00504"></a>00504     <span class="comment">// send the bottom half of my state vector to the top half of pairRank&apos;s qureg.pairStateVec</span>
<a name="l00505"></a>00505     <span class="comment">// receive pairRank&apos;s state vector into the top of qureg.pairStateVec</span>
<a name="l00506"></a>00506     <span class="keywordflow">for</span> (i=0; i&lt;numMessages; i++){
<a name="l00507"></a>00507         offset = i*maxMessageCount;
<a name="l00508"></a>00508         MPI_Sendrecv(&amp;qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real[offset+numAmpsToSend], maxMessageCount, 
<a name="l00509"></a>00509                 MPI_QuEST_REAL, pairRank, TAG,
<a name="l00510"></a>00510                 &amp;qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real[offset], maxMessageCount, MPI_QuEST_REAL,
<a name="l00511"></a>00511                 pairRank, TAG, MPI_COMM_WORLD, &amp;status);
<a name="l00512"></a>00512         <span class="comment">//printf(&quot;rank: %d err: %d\n&quot;, qureg.rank, err);</span>
<a name="l00513"></a>00513         MPI_Sendrecv(&amp;qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag[offset+numAmpsToSend], maxMessageCount, 
<a name="l00514"></a>00514                 MPI_QuEST_REAL, pairRank, TAG,
<a name="l00515"></a>00515                 &amp;qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag[offset], maxMessageCount, MPI_QuEST_REAL,
<a name="l00516"></a>00516                 pairRank, TAG, MPI_COMM_WORLD, &amp;status);
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="comment">//TODO -- decide where this function should go. It is a preparation for MPI data transfer function</span>
<a name="l00521"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a2ebf115d3bdd88f4b290b5218a5399d3">00521</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a2ebf115d3bdd88f4b290b5218a5399d3">compressPairVectorForSingleQubitDepolarise</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit){
<a name="l00522"></a>00522     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeInnerBlock, sizeInnerHalfBlock;
<a name="l00523"></a>00523     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeOuterColumn, sizeOuterHalfColumn;
<a name="l00524"></a>00524     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> thisInnerBlock, <span class="comment">// current block</span>
<a name="l00525"></a>00525          thisOuterColumn, <span class="comment">// current column in density matrix</span>
<a name="l00526"></a>00526          thisIndex,    <span class="comment">// current index in (density matrix representation) state vector</span>
<a name="l00527"></a>00527          thisIndexInOuterColumn,
<a name="l00528"></a>00528          thisIndexInInnerBlock;
<a name="l00529"></a>00529          
<a name="l00530"></a>00530     <span class="keywordtype">int</span> outerBit;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> thisTask;
<a name="l00533"></a>00533     <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numTasks=qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>&gt;&gt;1;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <span class="comment">// set dimensions</span>
<a name="l00536"></a>00536     sizeInnerHalfBlock = 1LL &lt;&lt; targetQubit;
<a name="l00537"></a>00537     sizeInnerBlock     = 2LL * sizeInnerHalfBlock;
<a name="l00538"></a>00538     sizeOuterHalfColumn = 1LL &lt;&lt; qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>;
<a name="l00539"></a>00539     sizeOuterColumn     = 2LL * sizeOuterHalfColumn;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 <span class="preprocessor"># ifdef _OPENMP</span>
<a name="l00542"></a>00542 <span class="preprocessor"></span><span class="preprocessor"># pragma omp parallel \</span>
<a name="l00543"></a>00543 <span class="preprocessor">    default  (none) \</span>
<a name="l00544"></a>00544 <span class="preprocessor">    shared   (sizeInnerBlock,sizeInnerHalfBlock,sizeOuterColumn,sizeOuterHalfColumn,qureg) \</span>
<a name="l00545"></a>00545 <span class="preprocessor">    private  (thisTask,thisInnerBlock,thisOuterColumn,thisIndex,thisIndexInOuterColumn, \</span>
<a name="l00546"></a>00546 <span class="preprocessor">                thisIndexInInnerBlock,outerBit) </span>
<a name="l00547"></a>00547 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00548"></a>00548 <span class="preprocessor"></span>    {
<a name="l00549"></a>00549 <span class="preprocessor"># ifdef _OPENMP</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span><span class="preprocessor"># pragma omp for schedule (static)</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00552"></a>00552 <span class="preprocessor"></span>        <span class="comment">// thisTask iterates over half the elements in this process&apos; chunk of the density matrix</span>
<a name="l00553"></a>00553         <span class="comment">// treat this as iterating over all columns, then iterating over half the values</span>
<a name="l00554"></a>00554         <span class="comment">// within one column.</span>
<a name="l00555"></a>00555         <span class="comment">// If this function has been called, this process&apos; chunk contains half an </span>
<a name="l00556"></a>00556         <span class="comment">// outer block or less</span>
<a name="l00557"></a>00557         <span class="keywordflow">for</span> (thisTask=0; thisTask&lt;numTasks; thisTask++) {
<a name="l00558"></a>00558             <span class="comment">// we want to process all columns in the density matrix,</span>
<a name="l00559"></a>00559             <span class="comment">// updating the values for half of each column (one half of each inner block)</span>
<a name="l00560"></a>00560             thisOuterColumn = thisTask / sizeOuterHalfColumn;
<a name="l00561"></a>00561             thisIndexInOuterColumn = thisTask&amp;(sizeOuterHalfColumn-1); <span class="comment">// thisTask % sizeOuterHalfColumn</span>
<a name="l00562"></a>00562             thisInnerBlock = thisIndexInOuterColumn/sizeInnerHalfBlock;
<a name="l00563"></a>00563             <span class="comment">// get index in state vector corresponding to upper inner block</span>
<a name="l00564"></a>00564             thisIndexInInnerBlock = thisTask&amp;(sizeInnerHalfBlock-1); <span class="comment">// thisTask % sizeInnerHalfBlock</span>
<a name="l00565"></a>00565             thisIndex = thisOuterColumn*sizeOuterColumn + thisInnerBlock*sizeInnerBlock
<a name="l00566"></a>00566                 + thisIndexInInnerBlock;
<a name="l00567"></a>00567             <span class="comment">// check if we are in the upper or lower half of an outer block</span>
<a name="l00568"></a>00568             outerBit = <a class="code" href="QuEST__cpu__distributed_8c.html#a100463f6ec212c76a5fad99579000505" title="Get the value of the bit at a particular index in a number.">extractBit</a>(targetQubit, (thisIndex+qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>*qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>)&gt;&gt;qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00569"></a>00569             <span class="comment">// if we are in the lower half of an outer block, shift to be in the lower half</span>
<a name="l00570"></a>00570             <span class="comment">// of the inner block as well (we want to dephase |0&gt;&lt;0| and |1&gt;&lt;1| only)</span>
<a name="l00571"></a>00571             thisIndex += outerBit*(sizeInnerHalfBlock);
<a name="l00572"></a>00572 
<a name="l00573"></a>00573             <span class="comment">// NOTE: at this point thisIndex should be the index of the element we want to </span>
<a name="l00574"></a>00574             <span class="comment">// dephase in the chunk of the state vector on this process, in the </span>
<a name="l00575"></a>00575             <span class="comment">// density matrix representation. </span>
<a name="l00576"></a>00576             <span class="comment">// thisTask is the index of the pair element in pairStateVec</span>
<a name="l00577"></a>00577             <span class="comment">// we will populate the second half of pairStateVec with this process&apos;</span>
<a name="l00578"></a>00578             <span class="comment">// data to send</span>
<a name="l00579"></a>00579 
<a name="l00580"></a>00580             qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real[thisTask+numTasks] = qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.real[thisIndex];
<a name="l00581"></a>00581             qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag[thisTask+numTasks] = qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.imag[thisIndex];
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         }
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00587"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a13a7c39357ba9a30339d7a6171aeda8d">00587</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__cpu__distributed_8c.html#a13a7c39357ba9a30339d7a6171aeda8d">compressPairVectorForTwoQubitDepolarise</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit,
<a name="l00588"></a>00588         <span class="keyword">const</span> <span class="keywordtype">int</span> qubit2) {
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeInnerBlockQ1, sizeInnerHalfBlockQ1;
<a name="l00591"></a>00591     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeInnerBlockQ2, sizeInnerHalfBlockQ2, sizeInnerQuarterBlockQ2;
<a name="l00592"></a>00592     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeOuterColumn, sizeOuterQuarterColumn;
<a name="l00593"></a>00593     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> 
<a name="l00594"></a>00594          thisInnerBlockQ2,
<a name="l00595"></a>00595          thisOuterColumn, <span class="comment">// current column in density matrix</span>
<a name="l00596"></a>00596          thisIndex,    <span class="comment">// current index in (density matrix representation) state vector</span>
<a name="l00597"></a>00597          thisIndexInOuterColumn,
<a name="l00598"></a>00598          thisIndexInInnerBlockQ1,
<a name="l00599"></a>00599          thisIndexInInnerBlockQ2,
<a name="l00600"></a>00600          thisInnerBlockQ1InInnerBlockQ2;
<a name="l00601"></a>00601     <span class="keywordtype">int</span> outerBitQ1, outerBitQ2;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> thisTask;
<a name="l00604"></a>00604     <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numTasks=qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>&gt;&gt;2;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     <span class="comment">// set dimensions</span>
<a name="l00607"></a>00607     sizeInnerHalfBlockQ1 = 1LL &lt;&lt; targetQubit;
<a name="l00608"></a>00608     sizeInnerHalfBlockQ2 = 1LL &lt;&lt; qubit2;
<a name="l00609"></a>00609     sizeInnerQuarterBlockQ2 = sizeInnerHalfBlockQ2 &gt;&gt; 1;
<a name="l00610"></a>00610     sizeInnerBlockQ2 = sizeInnerHalfBlockQ2 &lt;&lt; 1;
<a name="l00611"></a>00611     sizeInnerBlockQ1 = 2LL * sizeInnerHalfBlockQ1;
<a name="l00612"></a>00612     sizeOuterColumn = 1LL &lt;&lt; qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>;
<a name="l00613"></a>00613     sizeOuterQuarterColumn = sizeOuterColumn &gt;&gt; 2;
<a name="l00614"></a>00614  
<a name="l00615"></a>00615 <span class="preprocessor"># ifdef _OPENMP</span>
<a name="l00616"></a>00616 <span class="preprocessor"></span><span class="preprocessor"># pragma omp parallel \</span>
<a name="l00617"></a>00617 <span class="preprocessor">    default  (none) \</span>
<a name="l00618"></a>00618 <span class="preprocessor">    shared   (sizeInnerBlockQ1,sizeInnerHalfBlockQ1,sizeInnerQuarterBlockQ2,sizeInnerHalfBlockQ2,sizeInnerBlockQ2, \</span>
<a name="l00619"></a>00619 <span class="preprocessor">                sizeOuterColumn, \</span>
<a name="l00620"></a>00620 <span class="preprocessor">                sizeOuterQuarterColumn,qureg) \</span>
<a name="l00621"></a>00621 <span class="preprocessor">    private  (thisTask,thisInnerBlockQ2,thisOuterColumn,thisIndex,thisIndexInOuterColumn, \</span>
<a name="l00622"></a>00622 <span class="preprocessor">                thisIndexInInnerBlockQ1,thisIndexInInnerBlockQ2,thisInnerBlockQ1InInnerBlockQ2,outerBitQ1,outerBitQ2) </span>
<a name="l00623"></a>00623 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span>    {
<a name="l00625"></a>00625 <span class="preprocessor"># ifdef _OPENMP</span>
<a name="l00626"></a>00626 <span class="preprocessor"></span><span class="preprocessor"># pragma omp for schedule (static)</span>
<a name="l00627"></a>00627 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00628"></a>00628 <span class="preprocessor"></span>        <span class="comment">// thisTask iterates over half the elements in this process&apos; chunk of the density matrix</span>
<a name="l00629"></a>00629         <span class="comment">// treat this as iterating over all columns, then iterating over half the values</span>
<a name="l00630"></a>00630         <span class="comment">// within one column.</span>
<a name="l00631"></a>00631         <span class="comment">// If this function has been called, this process&apos; chunk contains half an </span>
<a name="l00632"></a>00632         <span class="comment">// outer block or less</span>
<a name="l00633"></a>00633         <span class="keywordflow">for</span> (thisTask=0; thisTask&lt;numTasks; thisTask++) {
<a name="l00634"></a>00634             <span class="comment">// we want to process all columns in the density matrix,</span>
<a name="l00635"></a>00635             <span class="comment">// updating the values for half of each column (one half of each inner block)</span>
<a name="l00636"></a>00636             thisOuterColumn = thisTask / sizeOuterQuarterColumn;
<a name="l00637"></a>00637             <span class="comment">// thisTask % sizeOuterQuarterColumn</span>
<a name="l00638"></a>00638             thisIndexInOuterColumn = thisTask&amp;(sizeOuterQuarterColumn-1);
<a name="l00639"></a>00639             thisInnerBlockQ2 = thisIndexInOuterColumn / sizeInnerQuarterBlockQ2;
<a name="l00640"></a>00640             <span class="comment">// thisTask % sizeInnerQuarterBlockQ2;</span>
<a name="l00641"></a>00641             thisIndexInInnerBlockQ2 = thisTask&amp;(sizeInnerQuarterBlockQ2-1);
<a name="l00642"></a>00642             thisInnerBlockQ1InInnerBlockQ2 = thisIndexInInnerBlockQ2 / sizeInnerHalfBlockQ1;
<a name="l00643"></a>00643             <span class="comment">// thisTask % sizeInnerHalfBlockQ1;</span>
<a name="l00644"></a>00644             thisIndexInInnerBlockQ1 = thisTask&amp;(sizeInnerHalfBlockQ1-1);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646             <span class="comment">// get index in state vector corresponding to upper inner block</span>
<a name="l00647"></a>00647             thisIndex = thisOuterColumn*sizeOuterColumn + thisInnerBlockQ2*sizeInnerBlockQ2
<a name="l00648"></a>00648                 + thisInnerBlockQ1InInnerBlockQ2*sizeInnerBlockQ1 + thisIndexInInnerBlockQ1;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650             <span class="comment">// check if we are in the upper or lower half of an outer block for Q1</span>
<a name="l00651"></a>00651             outerBitQ1 = <a class="code" href="QuEST__cpu__distributed_8c.html#a100463f6ec212c76a5fad99579000505" title="Get the value of the bit at a particular index in a number.">extractBit</a>(targetQubit, (thisIndex+qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>*qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>)&gt;&gt;qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00652"></a>00652             <span class="comment">// if we are in the lower half of an outer block, shift to be in the lower half</span>
<a name="l00653"></a>00653             <span class="comment">// of the inner block as well (we want to dephase |0&gt;&lt;0| and |1&gt;&lt;1| only)</span>
<a name="l00654"></a>00654             thisIndex += outerBitQ1*(sizeInnerHalfBlockQ1);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656             <span class="comment">// check if we are in the upper or lower half of an outer block for Q2</span>
<a name="l00657"></a>00657             outerBitQ2 = <a class="code" href="QuEST__cpu__distributed_8c.html#a100463f6ec212c76a5fad99579000505" title="Get the value of the bit at a particular index in a number.">extractBit</a>(qubit2, (thisIndex+qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>*qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>)&gt;&gt;qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00658"></a>00658             <span class="comment">// if we are in the lower half of an outer block, shift to be in the lower half</span>
<a name="l00659"></a>00659             <span class="comment">// of the inner block as well (we want to dephase |0&gt;&lt;0| and |1&gt;&lt;1| only)</span>
<a name="l00660"></a>00660             thisIndex += outerBitQ2*(sizeInnerQuarterBlockQ2&lt;&lt;1);
<a name="l00661"></a>00661 
<a name="l00662"></a>00662             <span class="comment">// NOTE: at this point thisIndex should be the index of the element we want to </span>
<a name="l00663"></a>00663             <span class="comment">// dephase in the chunk of the state vector on this process, in the </span>
<a name="l00664"></a>00664             <span class="comment">// density matrix representation. </span>
<a name="l00665"></a>00665             <span class="comment">// thisTask is the index of the pair element in pairStateVec</span>
<a name="l00666"></a>00666 
<a name="l00667"></a>00667             <span class="comment">// state[thisIndex] = (1-depolLevel)*state[thisIndex] + depolLevel*(state[thisIndex]</span>
<a name="l00668"></a>00668             <span class="comment">//      + pair[thisTask])/2</span>
<a name="l00669"></a>00669             qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.real[thisTask+numTasks*2] = qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.real[thisIndex];
<a name="l00670"></a>00670             qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>.imag[thisTask+numTasks*2] = qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>.imag[thisIndex];
<a name="l00671"></a>00671         }
<a name="l00672"></a>00672     }
<a name="l00673"></a>00673 }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 
<a name="l00676"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ae5bf84ca607e1484e0ddb5570726848d">00676</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#ae5bf84ca607e1484e0ddb5570726848d">densmatr_oneQubitDepolarise</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit, <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> depolLevel) {
<a name="l00677"></a>00677     <span class="keywordflow">if</span> (depolLevel == 0)
<a name="l00678"></a>00678         <span class="keywordflow">return</span>;
<a name="l00679"></a>00679     
<a name="l00680"></a>00680     <span class="keywordtype">int</span> rankIsUpper; <span class="comment">// rank is in the upper half of an outer block</span>
<a name="l00681"></a>00681     <span class="keywordtype">int</span> pairRank; <span class="comment">// rank of corresponding chunk</span>
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a076fe6125da4d6037b8bc4d912df4015">densityMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, 
<a name="l00684"></a>00684             qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>, targetQubit);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l00687"></a>00687         <a class="code" href="QuEST__cpu_8c.html#a5a0dd013940cf2ea20c397a551d9b781">densmatr_oneQubitDepolariseLocal</a>(qureg, targetQubit, depolLevel);
<a name="l00688"></a>00688     } <span class="keywordflow">else</span> {
<a name="l00689"></a>00689         <span class="comment">// pack data to send to my pair process into the first half of pairStateVec</span>
<a name="l00690"></a>00690         <a class="code" href="QuEST__cpu__distributed_8c.html#a2ebf115d3bdd88f4b290b5218a5399d3">compressPairVectorForSingleQubitDepolarise</a>(qureg, targetQubit);
<a name="l00691"></a>00691 
<a name="l00692"></a>00692         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#aa3c2d644a2be7f0d3aa9f757527d306f" title="fix -- do with masking instead">chunkIsUpperInOuterBlock</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit, 
<a name="l00693"></a>00693                 qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00694"></a>00694         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#ae66dc6569c6e4008c33d6739db422c08">getChunkOuterBlockPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, 
<a name="l00695"></a>00695                 targetQubit, qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00696"></a>00696 
<a name="l00697"></a>00697         <a class="code" href="QuEST__cpu__distributed_8c.html#a37dae401754961c9100b3c0907913c3e">exchangePairStateVectorHalves</a>(qureg, pairRank);
<a name="l00698"></a>00698         <a class="code" href="QuEST__cpu_8c.html#a48e0715ee615f2ce44477521ab760627">densmatr_oneQubitDepolariseDistributed</a>(qureg, targetQubit, depolLevel);
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00703"></a><a class="code" href="QuEST__cpu__distributed_8c.html#aa500e14a9ed1683f9c056f03f4c24cea">00703</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#aa500e14a9ed1683f9c056f03f4c24cea">densmatr_twoQubitDepolarise</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keywordtype">int</span> qubit1, <span class="keywordtype">int</span> qubit2, <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> depolLevel){
<a name="l00704"></a>00704     <span class="keywordflow">if</span> (depolLevel == 0)
<a name="l00705"></a>00705         <span class="keywordflow">return</span>;
<a name="l00706"></a>00706     <span class="keywordtype">int</span> rankIsUpperBiggerQubit, rankIsUpperSmallerQubit;
<a name="l00707"></a>00707     <span class="keywordtype">int</span> pairRank; <span class="comment">// rank of corresponding chunk</span>
<a name="l00708"></a>00708     <span class="keywordtype">int</span> biggerQubit, smallerQubit;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <a class="code" href="QuEST__internal_8h.html#a8fde996ce8ba014fce542549406813f9">densmatr_twoQubitDephase</a>(qureg, qubit1, qubit2, depolLevel);
<a name="l00711"></a>00711     
<a name="l00712"></a>00712     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> eta = 2/depolLevel;
<a name="l00713"></a>00713     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> delta = eta - 1 - sqrt( (eta-1)*(eta-1) - 1 ); 
<a name="l00714"></a>00714     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> gamma = 1+delta;
<a name="l00715"></a>00715     gamma = 1/(gamma*gamma*gamma);
<a name="l00716"></a>00716     <span class="keyword">const</span> <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> GAMMA_PARTS_1_OR_2 = 1.0;
<a name="l00717"></a>00717     <span class="comment">// TODO -- test delta too small</span>
<a name="l00718"></a>00718     <span class="comment">/*   </span>
<a name="l00719"></a>00719 <span class="comment">    if (fabs(4*delta*(1+delta)*gamma-depolLevel)&gt;1e-5){</span>
<a name="l00720"></a>00720 <span class="comment">        printf(&quot;Numerical error in delta; for small error rates try Taylor expansion.\n&quot;);</span>
<a name="l00721"></a>00721 <span class="comment">        exit(1);</span>
<a name="l00722"></a>00722 <span class="comment">    }</span>
<a name="l00723"></a>00723 <span class="comment">    */</span>
<a name="l00724"></a>00724     
<a name="l00725"></a>00725     biggerQubit = qubit1 &gt; qubit2 ? qubit1 : qubit2;
<a name="l00726"></a>00726     smallerQubit = qubit1 &lt; qubit2 ? qubit1 : qubit2;
<a name="l00727"></a>00727     <span class="keywordtype">int</span> useLocalDataOnlyBigQubit, useLocalDataOnlySmallQubit;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     useLocalDataOnlyBigQubit = <a class="code" href="QuEST__cpu__distributed_8c.html#a076fe6125da4d6037b8bc4d912df4015">densityMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, 
<a name="l00730"></a>00730         qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>, biggerQubit);
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (useLocalDataOnlyBigQubit){
<a name="l00732"></a>00732         <span class="comment">// does parts 1, 2 and 3 locally in one go</span>
<a name="l00733"></a>00733         <a class="code" href="QuEST__cpu_8c.html#a63a1b6169f59e86988aa519b71c496fb">densmatr_twoQubitDepolariseLocal</a>(qureg, qubit1, qubit2, delta, gamma);
<a name="l00734"></a>00734     } <span class="keywordflow">else</span> {
<a name="l00735"></a>00735         useLocalDataOnlySmallQubit = <a class="code" href="QuEST__cpu__distributed_8c.html#a076fe6125da4d6037b8bc4d912df4015">densityMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, 
<a name="l00736"></a>00736             qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>, smallerQubit);
<a name="l00737"></a>00737         <span class="keywordflow">if</span> (useLocalDataOnlySmallQubit){
<a name="l00738"></a>00738             <span class="comment">// do part 1 locally</span>
<a name="l00739"></a>00739             <a class="code" href="QuEST__cpu_8c.html#a7f8192d6f93ea1565a27a8556d48878b">densmatr_twoQubitDepolariseLocalPart1</a>(qureg, smallerQubit, biggerQubit, delta);
<a name="l00740"></a>00740             
<a name="l00741"></a>00741             <span class="comment">// do parts 2 and 3 distributed (if part 2 is distributed part 3 is also distributed)</span>
<a name="l00742"></a>00742             <span class="comment">// part 2 will be distributed and the value of the small qubit won&apos;t matter</span>
<a name="l00743"></a>00743             <a class="code" href="QuEST__cpu__distributed_8c.html#a13a7c39357ba9a30339d7a6171aeda8d">compressPairVectorForTwoQubitDepolarise</a>(qureg, smallerQubit, biggerQubit);
<a name="l00744"></a>00744             rankIsUpperBiggerQubit = <a class="code" href="QuEST__cpu__distributed_8c.html#aa3c2d644a2be7f0d3aa9f757527d306f" title="fix -- do with masking instead">chunkIsUpperInOuterBlock</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, biggerQubit, 
<a name="l00745"></a>00745                     qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00746"></a>00746             pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#ae66dc6569c6e4008c33d6739db422c08">getChunkOuterBlockPairId</a>(rankIsUpperBiggerQubit, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, 
<a name="l00747"></a>00747                     biggerQubit, qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749             <a class="code" href="QuEST__cpu__distributed_8c.html#a37dae401754961c9100b3c0907913c3e">exchangePairStateVectorHalves</a>(qureg, pairRank);
<a name="l00750"></a>00750             <a class="code" href="QuEST__cpu_8c.html#a4a51a641ea15f95481375ff76791e023">densmatr_twoQubitDepolariseDistributed</a>(qureg, smallerQubit, biggerQubit, delta, GAMMA_PARTS_1_OR_2);
<a name="l00751"></a>00751             
<a name="l00752"></a>00752             <span class="comment">// part 3 will be distributed but involve rearranging for the smaller qubit</span>
<a name="l00753"></a>00753             <a class="code" href="QuEST__cpu__distributed_8c.html#a13a7c39357ba9a30339d7a6171aeda8d">compressPairVectorForTwoQubitDepolarise</a>(qureg, smallerQubit, biggerQubit);
<a name="l00754"></a>00754             rankIsUpperBiggerQubit = <a class="code" href="QuEST__cpu__distributed_8c.html#aa3c2d644a2be7f0d3aa9f757527d306f" title="fix -- do with masking instead">chunkIsUpperInOuterBlock</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, biggerQubit, 
<a name="l00755"></a>00755                     qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00756"></a>00756             pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#ae66dc6569c6e4008c33d6739db422c08">getChunkOuterBlockPairId</a>(rankIsUpperBiggerQubit, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, 
<a name="l00757"></a>00757                     biggerQubit, qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00758"></a>00758 
<a name="l00759"></a>00759             <a class="code" href="QuEST__cpu__distributed_8c.html#a37dae401754961c9100b3c0907913c3e">exchangePairStateVectorHalves</a>(qureg, pairRank);
<a name="l00760"></a>00760             <a class="code" href="QuEST__cpu_8c.html#ae6946456e9b7814fc565f20622b9d2e5">densmatr_twoQubitDepolariseQ1LocalQ2DistributedPart3</a>(qureg, smallerQubit, biggerQubit, delta, gamma);
<a name="l00761"></a>00761         } <span class="keywordflow">else</span> {
<a name="l00762"></a>00762             <span class="comment">// do part 1, 2 and 3 distributed</span>
<a name="l00763"></a>00763             <span class="comment">// part 1</span>
<a name="l00764"></a>00764             <a class="code" href="QuEST__cpu__distributed_8c.html#a13a7c39357ba9a30339d7a6171aeda8d">compressPairVectorForTwoQubitDepolarise</a>(qureg, smallerQubit, biggerQubit);
<a name="l00765"></a>00765             rankIsUpperSmallerQubit = <a class="code" href="QuEST__cpu__distributed_8c.html#aa3c2d644a2be7f0d3aa9f757527d306f" title="fix -- do with masking instead">chunkIsUpperInOuterBlock</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, smallerQubit, 
<a name="l00766"></a>00766                     qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00767"></a>00767             pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#ae66dc6569c6e4008c33d6739db422c08">getChunkOuterBlockPairId</a>(rankIsUpperSmallerQubit, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, 
<a name="l00768"></a>00768                     smallerQubit, qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00769"></a>00769 
<a name="l00770"></a>00770             <a class="code" href="QuEST__cpu__distributed_8c.html#a37dae401754961c9100b3c0907913c3e">exchangePairStateVectorHalves</a>(qureg, pairRank);
<a name="l00771"></a>00771             <a class="code" href="QuEST__cpu_8c.html#a4a51a641ea15f95481375ff76791e023">densmatr_twoQubitDepolariseDistributed</a>(qureg, smallerQubit, biggerQubit, delta, GAMMA_PARTS_1_OR_2);
<a name="l00772"></a>00772 
<a name="l00773"></a>00773             <span class="comment">// part 2</span>
<a name="l00774"></a>00774             <a class="code" href="QuEST__cpu__distributed_8c.html#a13a7c39357ba9a30339d7a6171aeda8d">compressPairVectorForTwoQubitDepolarise</a>(qureg, smallerQubit, biggerQubit);
<a name="l00775"></a>00775             rankIsUpperBiggerQubit = <a class="code" href="QuEST__cpu__distributed_8c.html#aa3c2d644a2be7f0d3aa9f757527d306f" title="fix -- do with masking instead">chunkIsUpperInOuterBlock</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, biggerQubit, 
<a name="l00776"></a>00776                     qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00777"></a>00777             pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#ae66dc6569c6e4008c33d6739db422c08">getChunkOuterBlockPairId</a>(rankIsUpperBiggerQubit, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, 
<a name="l00778"></a>00778                     biggerQubit, qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780             <a class="code" href="QuEST__cpu__distributed_8c.html#a37dae401754961c9100b3c0907913c3e">exchangePairStateVectorHalves</a>(qureg, pairRank);
<a name="l00781"></a>00781             <a class="code" href="QuEST__cpu_8c.html#a4a51a641ea15f95481375ff76791e023">densmatr_twoQubitDepolariseDistributed</a>(qureg, smallerQubit, biggerQubit, delta, GAMMA_PARTS_1_OR_2);
<a name="l00782"></a>00782 
<a name="l00783"></a>00783             <span class="comment">// part 3</span>
<a name="l00784"></a>00784             <a class="code" href="QuEST__cpu__distributed_8c.html#a13a7c39357ba9a30339d7a6171aeda8d">compressPairVectorForTwoQubitDepolarise</a>(qureg, smallerQubit, biggerQubit);
<a name="l00785"></a>00785             pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#ab1ec7f241b68b079c8e316d190af49ce">getChunkOuterBlockPairIdForPart3</a>(rankIsUpperSmallerQubit, rankIsUpperBiggerQubit, 
<a name="l00786"></a>00786                     qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, smallerQubit, biggerQubit, qureg.<a class="code" href="structQureg.html#ad08dff5316b8937f4b2a1417591543dc" title="The number of qubits represented in either the state-vector or density matrix.">numQubitsRepresented</a>);
<a name="l00787"></a>00787             <a class="code" href="QuEST__cpu__distributed_8c.html#a37dae401754961c9100b3c0907913c3e">exchangePairStateVectorHalves</a>(qureg, pairRank);
<a name="l00788"></a>00788             <a class="code" href="QuEST__cpu_8c.html#a4a51a641ea15f95481375ff76791e023">densmatr_twoQubitDepolariseDistributed</a>(qureg, smallerQubit, biggerQubit, delta, gamma);
<a name="l00789"></a>00789 
<a name="l00790"></a>00790         }
<a name="l00791"></a>00791     }
<a name="l00792"></a>00792 
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00795"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a94ee4df9faba286ad7a5bc829ef5174d">00795</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a94ee4df9faba286ad7a5bc829ef5174d">statevec_compactUnitary</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> alpha, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> beta)
<a name="l00796"></a>00796 {
<a name="l00797"></a>00797     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l00798"></a>00798     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00799"></a>00799     <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> rot1, rot2;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801     <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l00802"></a>00802     <span class="keywordtype">int</span> rankIsUpper;
<a name="l00803"></a>00803     <span class="keywordtype">int</span> pairRank; <span class="comment">// rank of corresponding chunk</span>
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l00806"></a>00806         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l00807"></a>00807         <a class="code" href="QuEST__cpu_8c.html#aa5865e66a6e0993ae17d400c9ee0eb43">statevec_compactUnitaryLocal</a>(qureg, targetQubit, alpha, beta);
<a name="l00808"></a>00808     } <span class="keywordflow">else</span> {
<a name="l00809"></a>00809         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l00810"></a>00810         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00811"></a>00811         <a class="code" href="QuEST__cpu__distributed_8c.html#adb4b0373425b282abed27742d0ce0872" title="Get rotation values for a given chunk.">getRotAngle</a>(rankIsUpper, &amp;rot1, &amp;rot2, alpha, beta);
<a name="l00812"></a>00812         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00813"></a>00813         <span class="comment">// get corresponding values from my pair</span>
<a name="l00814"></a>00814         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l00815"></a>00815 
<a name="l00816"></a>00816         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block. </span>
<a name="l00817"></a>00817         <span class="comment">// send values to compactUnitaryDistributed in the correct order</span>
<a name="l00818"></a>00818         <span class="keywordflow">if</span> (rankIsUpper){
<a name="l00819"></a>00819             <a class="code" href="QuEST__cpu_8c.html#aede1ba1fc2d189001745ee6f76f8caa7" title="Rotate a single qubit in the state vector of probability amplitudes, given two complex...">statevec_compactUnitaryDistributed</a>(qureg,targetQubit,rot1,rot2,
<a name="l00820"></a>00820                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//upper</span>
<a name="l00821"></a>00821                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//lower</span>
<a name="l00822"></a>00822                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00823"></a>00823         } <span class="keywordflow">else</span> {
<a name="l00824"></a>00824             <a class="code" href="QuEST__cpu_8c.html#aede1ba1fc2d189001745ee6f76f8caa7" title="Rotate a single qubit in the state vector of probability amplitudes, given two complex...">statevec_compactUnitaryDistributed</a>(qureg,targetQubit,rot1,rot2,
<a name="l00825"></a>00825                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//upper</span>
<a name="l00826"></a>00826                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//lower</span>
<a name="l00827"></a>00827                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00828"></a>00828         }
<a name="l00829"></a>00829     }
<a name="l00830"></a>00830 }
<a name="l00831"></a>00831 
<a name="l00832"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a4bea7ed7967083cbabd8a8e5acdd48c0">00832</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a4bea7ed7967083cbabd8a8e5acdd48c0">statevec_unitary</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit, <a class="code" href="structComplexMatrix2.html" title="Represents a 2x2 matrix of complex numbers.">ComplexMatrix2</a> <a class="code" href="README_8md.html#a5d1c311241dc8d8ffa4badf059977dc5">u</a>)
<a name="l00833"></a>00833 {
<a name="l00834"></a>00834     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l00835"></a>00835     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00836"></a>00836     <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> rot1, rot2;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l00839"></a>00839     <span class="keywordtype">int</span> rankIsUpper;
<a name="l00840"></a>00840     <span class="keywordtype">int</span> pairRank; <span class="comment">// rank of corresponding chunk</span>
<a name="l00841"></a>00841 
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l00843"></a>00843         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l00844"></a>00844         <a class="code" href="QuEST__cpu_8c.html#a9f62ff38deae8ef012024d416d749c00">statevec_unitaryLocal</a>(qureg, targetQubit, u);
<a name="l00845"></a>00845     } <span class="keywordflow">else</span> {
<a name="l00846"></a>00846         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l00847"></a>00847         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00848"></a>00848         <a class="code" href="QuEST__cpu__distributed_8c.html#a5c9b2f129bdffaaba9857f6eddecbb17" title="Get rotation values for a given chunk given a unitary matrix.">getRotAngleFromUnitaryMatrix</a>(rankIsUpper, &amp;rot1, &amp;rot2, u);
<a name="l00849"></a>00849         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00850"></a>00850         <span class="comment">// get corresponding values from my pair</span>
<a name="l00851"></a>00851         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l00852"></a>00852 
<a name="l00853"></a>00853         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block. </span>
<a name="l00854"></a>00854         <span class="comment">// send values to compactUnitaryDistributed in the correct order</span>
<a name="l00855"></a>00855         <span class="keywordflow">if</span> (rankIsUpper){
<a name="l00856"></a>00856             <a class="code" href="QuEST__cpu_8c.html#a62c5d85e323f2c3eea2b7fa6d8c193ea" title="Apply a unitary operation to a single qubit given a subset of the state vector with...">statevec_unitaryDistributed</a>(qureg,targetQubit,rot1,rot2,
<a name="l00857"></a>00857                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//upper</span>
<a name="l00858"></a>00858                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//lower</span>
<a name="l00859"></a>00859                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00860"></a>00860         } <span class="keywordflow">else</span> {
<a name="l00861"></a>00861             <a class="code" href="QuEST__cpu_8c.html#a62c5d85e323f2c3eea2b7fa6d8c193ea" title="Apply a unitary operation to a single qubit given a subset of the state vector with...">statevec_unitaryDistributed</a>(qureg,targetQubit,rot1,rot2,
<a name="l00862"></a>00862                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//upper</span>
<a name="l00863"></a>00863                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//lower</span>
<a name="l00864"></a>00864                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00865"></a>00865         }
<a name="l00866"></a>00866     }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 
<a name="l00869"></a>00869 }
<a name="l00870"></a>00870 
<a name="l00871"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a47b467a5445c7f15d1a8b0b2ec0ef2de">00871</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a47b467a5445c7f15d1a8b0b2ec0ef2de">statevec_controlledCompactUnitary</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> controlQubit, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> alpha, <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> beta)
<a name="l00872"></a>00872 {
<a name="l00873"></a>00873     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l00874"></a>00874     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00875"></a>00875     <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> rot1, rot2;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l00878"></a>00878     <span class="keywordtype">int</span> rankIsUpper;
<a name="l00879"></a>00879     <span class="keywordtype">int</span> pairRank; <span class="comment">// rank of corresponding chunk</span>
<a name="l00880"></a>00880 
<a name="l00881"></a>00881     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l00882"></a>00882         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l00883"></a>00883         <a class="code" href="QuEST__cpu_8c.html#a0e5527c6e144fab8062ea5296e8bdf2a">statevec_controlledCompactUnitaryLocal</a>(qureg, controlQubit, targetQubit, alpha, beta);
<a name="l00884"></a>00884     } <span class="keywordflow">else</span> {
<a name="l00885"></a>00885         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l00886"></a>00886         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00887"></a>00887         <a class="code" href="QuEST__cpu__distributed_8c.html#adb4b0373425b282abed27742d0ce0872" title="Get rotation values for a given chunk.">getRotAngle</a>(rankIsUpper, &amp;rot1, &amp;rot2, alpha, beta);
<a name="l00888"></a>00888         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00889"></a>00889         <span class="comment">//printf(&quot;%d rank has pair rank: %d\n&quot;, qureg.rank, pairRank);</span>
<a name="l00890"></a>00890         <span class="comment">// get corresponding values from my pair</span>
<a name="l00891"></a>00891         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l00892"></a>00892 
<a name="l00893"></a>00893         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block. send values to controlledCompactUnitaryDistributed</span>
<a name="l00894"></a>00894         <span class="comment">// in the correct order</span>
<a name="l00895"></a>00895         <span class="keywordflow">if</span> (rankIsUpper){
<a name="l00896"></a>00896             <a class="code" href="QuEST__cpu_8c.html#a5837db2f736dce21fb28dad168a23130" title="Rotate a single qubit in the state vector of probability amplitudes, given two complex...">statevec_controlledCompactUnitaryDistributed</a>(qureg,controlQubit,targetQubit,rot1,rot2,
<a name="l00897"></a>00897                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//upper</span>
<a name="l00898"></a>00898                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//lower</span>
<a name="l00899"></a>00899                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00900"></a>00900         } <span class="keywordflow">else</span> {
<a name="l00901"></a>00901             <a class="code" href="QuEST__cpu_8c.html#a5837db2f736dce21fb28dad168a23130" title="Rotate a single qubit in the state vector of probability amplitudes, given two complex...">statevec_controlledCompactUnitaryDistributed</a>(qureg,controlQubit,targetQubit,rot1,rot2,
<a name="l00902"></a>00902                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//upper</span>
<a name="l00903"></a>00903                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//lower</span>
<a name="l00904"></a>00904                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00905"></a>00905         }
<a name="l00906"></a>00906     }
<a name="l00907"></a>00907 }
<a name="l00908"></a>00908 
<a name="l00909"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a2600999a19c817bfcf7ca14779e33b9a">00909</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a2600999a19c817bfcf7ca14779e33b9a">statevec_controlledUnitary</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> controlQubit, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit, 
<a name="l00910"></a>00910         <a class="code" href="structComplexMatrix2.html" title="Represents a 2x2 matrix of complex numbers.">ComplexMatrix2</a> <a class="code" href="README_8md.html#a5d1c311241dc8d8ffa4badf059977dc5">u</a>)
<a name="l00911"></a>00911 {
<a name="l00912"></a>00912     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l00913"></a>00913     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00914"></a>00914     <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> rot1, rot2;
<a name="l00915"></a>00915 
<a name="l00916"></a>00916     <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l00917"></a>00917     <span class="keywordtype">int</span> rankIsUpper;
<a name="l00918"></a>00918     <span class="keywordtype">int</span> pairRank; <span class="comment">// rank of corresponding chunk</span>
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l00921"></a>00921         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l00922"></a>00922         <a class="code" href="QuEST__cpu_8c.html#ac0c120ac374b402c576c4b38bcda9992">statevec_controlledUnitaryLocal</a>(qureg, controlQubit, targetQubit, u);
<a name="l00923"></a>00923     } <span class="keywordflow">else</span> {
<a name="l00924"></a>00924         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l00925"></a>00925         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00926"></a>00926         <a class="code" href="QuEST__cpu__distributed_8c.html#a5c9b2f129bdffaaba9857f6eddecbb17" title="Get rotation values for a given chunk given a unitary matrix.">getRotAngleFromUnitaryMatrix</a>(rankIsUpper, &amp;rot1, &amp;rot2, u);
<a name="l00927"></a>00927         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00928"></a>00928         <span class="comment">//printf(&quot;%d rank has pair rank: %d\n&quot;, qureg.rank, pairRank);</span>
<a name="l00929"></a>00929         <span class="comment">// get corresponding values from my pair</span>
<a name="l00930"></a>00930         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l00931"></a>00931 
<a name="l00932"></a>00932         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block. send values to controlledUnitaryDistributed</span>
<a name="l00933"></a>00933         <span class="comment">// in the correct order</span>
<a name="l00934"></a>00934         <span class="keywordflow">if</span> (rankIsUpper){
<a name="l00935"></a>00935             <a class="code" href="QuEST__cpu_8c.html#a4f77ef0be5137ed64321c2d6d14d8035" title="Rotate a single qubit in the state vector of probability amplitudes, given two complex...">statevec_controlledUnitaryDistributed</a>(qureg,controlQubit,targetQubit,rot1,rot2,
<a name="l00936"></a>00936                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//upper</span>
<a name="l00937"></a>00937                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//lower</span>
<a name="l00938"></a>00938                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00939"></a>00939         } <span class="keywordflow">else</span> {
<a name="l00940"></a>00940             <a class="code" href="QuEST__cpu_8c.html#a4f77ef0be5137ed64321c2d6d14d8035" title="Rotate a single qubit in the state vector of probability amplitudes, given two complex...">statevec_controlledUnitaryDistributed</a>(qureg,controlQubit,targetQubit,rot1,rot2,
<a name="l00941"></a>00941                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//upper</span>
<a name="l00942"></a>00942                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//lower</span>
<a name="l00943"></a>00943                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945     }
<a name="l00946"></a>00946 }
<a name="l00947"></a>00947 
<a name="l00948"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a2cc288d53df484516cde923c8a3b561a">00948</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a2cc288d53df484516cde923c8a3b561a">statevec_multiControlledUnitary</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keywordtype">int</span>* controlQubits, <span class="keyword">const</span> <span class="keywordtype">int</span> numControlQubits, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit, <a class="code" href="structComplexMatrix2.html" title="Represents a 2x2 matrix of complex numbers.">ComplexMatrix2</a> <a class="code" href="README_8md.html#a5d1c311241dc8d8ffa4badf059977dc5">u</a>)
<a name="l00949"></a>00949 {
<a name="l00950"></a>00950     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> mask=0;
<a name="l00951"></a>00951     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numControlQubits; i++) mask = mask | (1LL&lt;&lt;controlQubits[i]);
<a name="l00952"></a>00952 
<a name="l00953"></a>00953     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l00954"></a>00954     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00955"></a>00955     <a class="code" href="structComplex.html" title="Represents one complex number.">Complex</a> rot1, rot2;
<a name="l00956"></a>00956 
<a name="l00957"></a>00957     <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l00958"></a>00958     <span class="keywordtype">int</span> rankIsUpper;
<a name="l00959"></a>00959     <span class="keywordtype">int</span> pairRank; <span class="comment">// rank of corresponding chunk</span>
<a name="l00960"></a>00960 
<a name="l00961"></a>00961     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l00962"></a>00962         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l00963"></a>00963         <a class="code" href="QuEST__cpu_8c.html#ae183f44166ccfd908609c4e2207cc14b">statevec_multiControlledUnitaryLocal</a>(qureg, targetQubit, mask, u);
<a name="l00964"></a>00964     } <span class="keywordflow">else</span> {
<a name="l00965"></a>00965         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l00966"></a>00966         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00967"></a>00967         <a class="code" href="QuEST__cpu__distributed_8c.html#a5c9b2f129bdffaaba9857f6eddecbb17" title="Get rotation values for a given chunk given a unitary matrix.">getRotAngleFromUnitaryMatrix</a>(rankIsUpper, &amp;rot1, &amp;rot2, u);
<a name="l00968"></a>00968         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00969"></a>00969         <span class="comment">//printf(&quot;%d rank has pair rank: %d\n&quot;, qureg.rank, pairRank);</span>
<a name="l00970"></a>00970         <span class="comment">// get corresponding values from my pair</span>
<a name="l00971"></a>00971         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block. send values to multiControlledUnitaryDistributed</span>
<a name="l00974"></a>00974         <span class="comment">// in the correct order</span>
<a name="l00975"></a>00975         <span class="keywordflow">if</span> (rankIsUpper){
<a name="l00976"></a>00976             <a class="code" href="QuEST__cpu_8c.html#a2e6d75b454747741b2b805bf6b23194c" title="Apply a unitary operation to a single qubit in the state vector of probability amplitudes...">statevec_multiControlledUnitaryDistributed</a>(qureg,targetQubit,mask,rot1,rot2,
<a name="l00977"></a>00977                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//upper</span>
<a name="l00978"></a>00978                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//lower</span>
<a name="l00979"></a>00979                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00980"></a>00980         } <span class="keywordflow">else</span> {
<a name="l00981"></a>00981             <a class="code" href="QuEST__cpu_8c.html#a2e6d75b454747741b2b805bf6b23194c" title="Apply a unitary operation to a single qubit in the state vector of probability amplitudes...">statevec_multiControlledUnitaryDistributed</a>(qureg,targetQubit,mask,rot1,rot2,
<a name="l00982"></a>00982                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//upper</span>
<a name="l00983"></a>00983                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//lower</span>
<a name="l00984"></a>00984                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//output</span>
<a name="l00985"></a>00985         }
<a name="l00986"></a>00986     }
<a name="l00987"></a>00987 }
<a name="l00988"></a><a class="code" href="QuEST__cpu__distributed_8c.html#abdb6e0ee1e407755e1b944086cedd90e">00988</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#abdb6e0ee1e407755e1b944086cedd90e">statevec_pauliX</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit)
<a name="l00989"></a>00989 {
<a name="l00990"></a>00990     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l00991"></a>00991     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l00994"></a>00994     <span class="keywordtype">int</span> rankIsUpper;
<a name="l00995"></a>00995     <span class="keywordtype">int</span> pairRank; <span class="comment">// rank of corresponding chunk</span>
<a name="l00996"></a>00996 
<a name="l00997"></a>00997     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l00998"></a>00998         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l00999"></a>00999         <a class="code" href="QuEST__cpu_8c.html#a842aaecd6d6cdc194c0b7c84623d2111">statevec_pauliXLocal</a>(qureg, targetQubit);
<a name="l01000"></a>01000     } <span class="keywordflow">else</span> {
<a name="l01001"></a>01001         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l01002"></a>01002         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01003"></a>01003         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01004"></a>01004         <span class="comment">//printf(&quot;%d rank has pair rank: %d\n&quot;, qureg.rank, pairRank);</span>
<a name="l01005"></a>01005         <span class="comment">// get corresponding values from my pair</span>
<a name="l01006"></a>01006         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l01007"></a>01007         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block. pauliX just replaces</span>
<a name="l01008"></a>01008         <span class="comment">// this rank&apos;s values with pair values</span>
<a name="l01009"></a>01009         <a class="code" href="QuEST__cpu_8c.html#ac4f8a0ab089bc002fd85cd87f8c451e9" title="Rotate a single qubit by {{0,1},{1,0}.">statevec_pauliXDistributed</a>(qureg, targetQubit,
<a name="l01010"></a>01010                 qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">// in</span>
<a name="l01011"></a>01011                 qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">// out</span>
<a name="l01012"></a>01012     }
<a name="l01013"></a>01013 }
<a name="l01014"></a>01014 
<a name="l01015"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a114038296eb404b9b8a66aaad7b48800">01015</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a114038296eb404b9b8a66aaad7b48800">statevec_controlledNot</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> controlQubit, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit)
<a name="l01016"></a>01016 {
<a name="l01017"></a>01017     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l01018"></a>01018     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01019"></a>01019     <span class="keywordtype">int</span> rankIsUpper;    <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l01020"></a>01020     <span class="keywordtype">int</span> pairRank;               <span class="comment">// rank of corresponding chunk</span>
<a name="l01021"></a>01021 
<a name="l01022"></a>01022     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l01023"></a>01023         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l01024"></a>01024         <a class="code" href="QuEST__cpu_8c.html#a11c9685e4ad1f44cfd6243e0c4435893">statevec_controlledNotLocal</a>(qureg, controlQubit, targetQubit);
<a name="l01025"></a>01025     } <span class="keywordflow">else</span> {
<a name="l01026"></a>01026         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l01027"></a>01027         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01028"></a>01028         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01029"></a>01029         <span class="comment">// get corresponding values from my pair</span>
<a name="l01030"></a>01030         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l01031"></a>01031         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block</span>
<a name="l01032"></a>01032         <span class="keywordflow">if</span> (rankIsUpper){
<a name="l01033"></a>01033             <a class="code" href="QuEST__cpu_8c.html#afa036cb8b502ef9a0977885ea74e41bc" title="Rotate a single qubit by {{0,1},{1,0}.">statevec_controlledNotDistributed</a>(qureg,controlQubit,targetQubit,
<a name="l01034"></a>01034                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//in</span>
<a name="l01035"></a>01035                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//out</span>
<a name="l01036"></a>01036         } <span class="keywordflow">else</span> {
<a name="l01037"></a>01037             <a class="code" href="QuEST__cpu_8c.html#afa036cb8b502ef9a0977885ea74e41bc" title="Rotate a single qubit by {{0,1},{1,0}.">statevec_controlledNotDistributed</a>(qureg,controlQubit,targetQubit,
<a name="l01038"></a>01038                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//in</span>
<a name="l01039"></a>01039                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>); <span class="comment">//out</span>
<a name="l01040"></a>01040         }
<a name="l01041"></a>01041     }
<a name="l01042"></a>01042 }
<a name="l01043"></a>01043 
<a name="l01044"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a73b56fbac6e464a37805fa9d9657a8f9">01044</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a73b56fbac6e464a37805fa9d9657a8f9">statevec_pauliY</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit)
<a name="l01045"></a>01045 {       
<a name="l01046"></a>01046         <span class="keywordtype">int</span> conjFac = 1;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l01049"></a>01049     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01050"></a>01050     <span class="keywordtype">int</span> rankIsUpper;    <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l01051"></a>01051     <span class="keywordtype">int</span> pairRank;               <span class="comment">// rank of corresponding chunk</span>
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l01054"></a>01054         <a class="code" href="QuEST__cpu_8c.html#a8edf5f2066b05fb343931f45e2bec8f8">statevec_pauliYLocal</a>(qureg, targetQubit, conjFac);
<a name="l01055"></a>01055     } <span class="keywordflow">else</span> {
<a name="l01056"></a>01056         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l01057"></a>01057         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01058"></a>01058         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01059"></a>01059         <span class="comment">// get corresponding values from my pair</span>
<a name="l01060"></a>01060         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l01061"></a>01061         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block</span>
<a name="l01062"></a>01062         <a class="code" href="QuEST__cpu_8c.html#a04cdf71c5862ab2bf3a98cd0b3ea0c26" title="Rotate a single qubit by +-{{0,-i},{i,0}.">statevec_pauliYDistributed</a>(qureg,targetQubit,
<a name="l01063"></a>01063                 qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">// in</span>
<a name="l01064"></a>01064                 qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">// out</span>
<a name="l01065"></a>01065                 rankIsUpper, conjFac);
<a name="l01066"></a>01066     }
<a name="l01067"></a>01067 }
<a name="l01068"></a>01068 
<a name="l01069"></a><a class="code" href="QuEST__cpu__distributed_8c.html#aee97816cfabeea7874cd837a8d105412">01069</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#aee97816cfabeea7874cd837a8d105412">statevec_pauliYConj</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit)
<a name="l01070"></a>01070 {       
<a name="l01071"></a>01071         <span class="keywordtype">int</span> conjFac = -1;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l01074"></a>01074     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01075"></a>01075     <span class="keywordtype">int</span> rankIsUpper;    <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l01076"></a>01076     <span class="keywordtype">int</span> pairRank;               <span class="comment">// rank of corresponding chunk</span>
<a name="l01077"></a>01077 
<a name="l01078"></a>01078     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l01079"></a>01079         <a class="code" href="QuEST__cpu_8c.html#a8edf5f2066b05fb343931f45e2bec8f8">statevec_pauliYLocal</a>(qureg, targetQubit, conjFac);
<a name="l01080"></a>01080     } <span class="keywordflow">else</span> {
<a name="l01081"></a>01081         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l01082"></a>01082         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01083"></a>01083         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01084"></a>01084         <span class="comment">// get corresponding values from my pair</span>
<a name="l01085"></a>01085         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l01086"></a>01086         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block</span>
<a name="l01087"></a>01087         <a class="code" href="QuEST__cpu_8c.html#a04cdf71c5862ab2bf3a98cd0b3ea0c26" title="Rotate a single qubit by +-{{0,-i},{i,0}.">statevec_pauliYDistributed</a>(qureg,targetQubit,
<a name="l01088"></a>01088                 qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">// in</span>
<a name="l01089"></a>01089                 qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">// out</span>
<a name="l01090"></a>01090                 rankIsUpper, conjFac);
<a name="l01091"></a>01091     }
<a name="l01092"></a>01092 }
<a name="l01093"></a>01093 
<a name="l01094"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a708246b16236c492094c2633da0c08ff">01094</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a708246b16236c492094c2633da0c08ff">statevec_controlledPauliY</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> controlQubit, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit)
<a name="l01095"></a>01095 {
<a name="l01096"></a>01096         <span class="keywordtype">int</span> conjFac = 1;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l01099"></a>01099     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01100"></a>01100     <span class="keywordtype">int</span> rankIsUpper;    <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l01101"></a>01101     <span class="keywordtype">int</span> pairRank;               <span class="comment">// rank of corresponding chunk</span>
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l01104"></a>01104         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l01105"></a>01105         <a class="code" href="QuEST__cpu_8c.html#a9028deac63419d71d523f73229a7bd84">statevec_controlledPauliYLocal</a>(qureg, controlQubit, targetQubit, conjFac);
<a name="l01106"></a>01106     } <span class="keywordflow">else</span> {
<a name="l01107"></a>01107         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l01108"></a>01108         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01109"></a>01109         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01110"></a>01110         <span class="comment">// get corresponding values from my pair</span>
<a name="l01111"></a>01111         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l01112"></a>01112         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block</span>
<a name="l01113"></a>01113         <span class="keywordflow">if</span> (rankIsUpper){
<a name="l01114"></a>01114             <a class="code" href="QuEST__cpu_8c.html#a85014e8266bebf037bc2d66f80ca5936">statevec_controlledPauliYDistributed</a>(qureg,controlQubit,targetQubit,
<a name="l01115"></a>01115                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//in</span>
<a name="l01116"></a>01116                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>,
<a name="l01117"></a>01117                                         conjFac); <span class="comment">//out</span>
<a name="l01118"></a>01118         } <span class="keywordflow">else</span> {
<a name="l01119"></a>01119             <a class="code" href="QuEST__cpu_8c.html#a85014e8266bebf037bc2d66f80ca5936">statevec_controlledPauliYDistributed</a>(qureg,controlQubit,targetQubit,
<a name="l01120"></a>01120                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//in</span>
<a name="l01121"></a>01121                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>,
<a name="l01122"></a>01122                                         conjFac); <span class="comment">//out</span>
<a name="l01123"></a>01123         }
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125 }
<a name="l01126"></a>01126 
<a name="l01127"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a9e647339720bf82b30c6331fad544ec5">01127</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a9e647339720bf82b30c6331fad544ec5">statevec_controlledPauliYConj</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> controlQubit, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit)
<a name="l01128"></a>01128 {
<a name="l01129"></a>01129         <span class="keywordtype">int</span> conjFac = -1;
<a name="l01130"></a>01130 
<a name="l01131"></a>01131     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l01132"></a>01132     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01133"></a>01133     <span class="keywordtype">int</span> rankIsUpper;    <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l01134"></a>01134     <span class="keywordtype">int</span> pairRank;               <span class="comment">// rank of corresponding chunk</span>
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l01137"></a>01137         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l01138"></a>01138         <a class="code" href="QuEST__cpu_8c.html#a9028deac63419d71d523f73229a7bd84">statevec_controlledPauliYLocal</a>(qureg, controlQubit, targetQubit, conjFac);
<a name="l01139"></a>01139     } <span class="keywordflow">else</span> {
<a name="l01140"></a>01140         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l01141"></a>01141         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01142"></a>01142         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01143"></a>01143         <span class="comment">// get corresponding values from my pair</span>
<a name="l01144"></a>01144         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l01145"></a>01145         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block</span>
<a name="l01146"></a>01146         <span class="keywordflow">if</span> (rankIsUpper){
<a name="l01147"></a>01147             <a class="code" href="QuEST__cpu_8c.html#a85014e8266bebf037bc2d66f80ca5936">statevec_controlledPauliYDistributed</a>(qureg,controlQubit,targetQubit,
<a name="l01148"></a>01148                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//in</span>
<a name="l01149"></a>01149                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>,
<a name="l01150"></a>01150                                         conjFac); <span class="comment">//out</span>
<a name="l01151"></a>01151         } <span class="keywordflow">else</span> {
<a name="l01152"></a>01152             <a class="code" href="QuEST__cpu_8c.html#a85014e8266bebf037bc2d66f80ca5936">statevec_controlledPauliYDistributed</a>(qureg,controlQubit,targetQubit,
<a name="l01153"></a>01153                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//in</span>
<a name="l01154"></a>01154                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>,
<a name="l01155"></a>01155                                         conjFac); <span class="comment">//out</span>
<a name="l01156"></a>01156         }
<a name="l01157"></a>01157     }
<a name="l01158"></a>01158 }
<a name="l01159"></a>01159 
<a name="l01160"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a9226f386d010aaa85efc0e8889d341d5">01160</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#a9226f386d010aaa85efc0e8889d341d5">statevec_hadamard</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> targetQubit)
<a name="l01161"></a>01161 {
<a name="l01162"></a>01162     <span class="comment">// flag to require memory exchange. 1: an entire block fits on one rank, 0: at most half a block fits on one rank</span>
<a name="l01163"></a>01163     <span class="keywordtype">int</span> useLocalDataOnly = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01164"></a>01164 
<a name="l01165"></a>01165     <span class="comment">// rank&apos;s chunk is in upper half of block </span>
<a name="l01166"></a>01166     <span class="keywordtype">int</span> rankIsUpper;
<a name="l01167"></a>01167     <span class="keywordtype">int</span> pairRank; <span class="comment">// rank of corresponding chunk</span>
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     <span class="keywordflow">if</span> (useLocalDataOnly){
<a name="l01170"></a>01170         <span class="comment">// all values required to update state vector lie in this rank</span>
<a name="l01171"></a>01171         <a class="code" href="QuEST__cpu_8c.html#a24f9ade18290c82bbb2c4a706b3d5999">statevec_hadamardLocal</a>(qureg, targetQubit);
<a name="l01172"></a>01172     } <span class="keywordflow">else</span> {
<a name="l01173"></a>01173         <span class="comment">// need to get corresponding chunk of state vector from other rank</span>
<a name="l01174"></a>01174         rankIsUpper = <a class="code" href="QuEST__cpu__distributed_8c.html#a0552889d6f57d9e0ed8b209bf426482d" title="Returns whether a given chunk in position chunkId is in the upper or lower half of...">chunkIsUpper</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01175"></a>01175         pairRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a7dba097f23f5d48dfdc9f3250444e2e4" title="get position of corresponding chunk, holding values required to update values in...">getChunkPairId</a>(rankIsUpper, qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, targetQubit);
<a name="l01176"></a>01176         <span class="comment">//printf(&quot;%d rank has pair rank: %d\n&quot;, qureg.rank, pairRank);</span>
<a name="l01177"></a>01177         <span class="comment">// get corresponding values from my pair</span>
<a name="l01178"></a>01178         <a class="code" href="QuEST__cpu__distributed_8c.html#ae01c3eb75fd32de1a7e1dbc7a33a21e3">exchangeStateVectors</a>(qureg, pairRank);
<a name="l01179"></a>01179         <span class="comment">// this rank&apos;s values are either in the upper of lower half of the block. send values to hadamardDistributed</span>
<a name="l01180"></a>01180         <span class="comment">// in the correct order</span>
<a name="l01181"></a>01181         <span class="keywordflow">if</span> (rankIsUpper){
<a name="l01182"></a>01182             <a class="code" href="QuEST__cpu_8c.html#a4271beeba4f1bec3556779aab318cdab" title="Rotate a single qubit by {{1,1},{1,-1}}/sqrt2.">statevec_hadamardDistributed</a>(qureg,targetQubit,
<a name="l01183"></a>01183                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//upper</span>
<a name="l01184"></a>01184                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//lower</span>
<a name="l01185"></a>01185                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, rankIsUpper); <span class="comment">//output</span>
<a name="l01186"></a>01186         } <span class="keywordflow">else</span> {
<a name="l01187"></a>01187             <a class="code" href="QuEST__cpu_8c.html#a4271beeba4f1bec3556779aab318cdab" title="Rotate a single qubit by {{1,1},{1,-1}}/sqrt2.">statevec_hadamardDistributed</a>(qureg,targetQubit,
<a name="l01188"></a>01188                     qureg.<a class="code" href="structQureg.html#aba97773694870ef35e378c036f486bb7" title="Temporary storage for a chunk of the state vector received from another process in...">pairStateVec</a>, <span class="comment">//upper</span>
<a name="l01189"></a>01189                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, <span class="comment">//lower</span>
<a name="l01190"></a>01190                     qureg.<a class="code" href="structQureg.html#a441e4cacef6bd17adb9813c7442d42fe" title="Computational state amplitudes - a subset thereof in the MPI version.">stateVec</a>, rankIsUpper); <span class="comment">//output</span>
<a name="l01191"></a>01191         }
<a name="l01192"></a>01192     }
<a name="l01193"></a>01193 }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195 
<a name="l01206"></a><a class="code" href="QuEST__cpu__distributed_8c.html#af0ea25f00987af4c53f17c9cca62ab41">01206</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="QuEST__cpu__distributed_8c.html#af0ea25f00987af4c53f17c9cca62ab41" title="Find chunks to skip when calculating probability of qubit being zero.">isChunkToSkipInFindPZero</a>(<span class="keywordtype">int</span> chunkId, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">int</span> measureQubit)
<a name="l01207"></a>01207 {
<a name="l01208"></a>01208     <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sizeHalfBlock = 1LL &lt;&lt; (measureQubit);
<a name="l01209"></a>01209     <span class="keywordtype">int</span> numChunksToSkip = sizeHalfBlock/chunkSize;
<a name="l01210"></a>01210     <span class="comment">// calculate probability by summing over numChunksToSkip, then skipping numChunksToSkip, etc</span>
<a name="l01211"></a>01211     <span class="keywordtype">int</span> bitToCheck = chunkId &amp; numChunksToSkip;
<a name="l01212"></a>01212     <span class="keywordflow">return</span> bitToCheck;
<a name="l01213"></a>01213 }
<a name="l01214"></a>01214 
<a name="l01215"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ab33cdf01831c4545e51299178acf7f27">01215</a> <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="QuEST__internal_8h.html#ab33cdf01831c4545e51299178acf7f27">statevec_calcProbOfOutcome</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> measureQubit, <span class="keywordtype">int</span> outcome)
<a name="l01216"></a>01216 {
<a name="l01217"></a>01217     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> stateProb=0, totalStateProb=0;
<a name="l01218"></a>01218     <span class="keywordtype">int</span> skipValuesWithinRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, measureQubit);
<a name="l01219"></a>01219     <span class="keywordflow">if</span> (skipValuesWithinRank) {
<a name="l01220"></a>01220         stateProb = <a class="code" href="QuEST__cpu_8c.html#afa06d0143cea46f1e425c61ac6f6f9a2" title="Measure the total probability of a specified qubit being in the zero state across...">statevec_findProbabilityOfZeroLocal</a>(qureg, measureQubit);
<a name="l01221"></a>01221     } <span class="keywordflow">else</span> {
<a name="l01222"></a>01222         <span class="keywordflow">if</span> (!<a class="code" href="QuEST__cpu__distributed_8c.html#af0ea25f00987af4c53f17c9cca62ab41" title="Find chunks to skip when calculating probability of qubit being zero.">isChunkToSkipInFindPZero</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, measureQubit)){
<a name="l01223"></a>01223             stateProb = <a class="code" href="QuEST__cpu_8c.html#aa2e838d65b214d266cd51ad0091ad827" title="Measure the probability of a specified qubit being in the zero state across all amplitudes...">statevec_findProbabilityOfZeroDistributed</a>(qureg, measureQubit);
<a name="l01224"></a>01224         } <span class="keywordflow">else</span> stateProb = 0;
<a name="l01225"></a>01225     }
<a name="l01226"></a>01226     MPI_Allreduce(&amp;stateProb, &amp;totalStateProb, 1, MPI_QuEST_REAL, MPI_SUM, MPI_COMM_WORLD);
<a name="l01227"></a>01227     <span class="keywordflow">if</span> (outcome==1) totalStateProb = 1.0 - totalStateProb;
<a name="l01228"></a>01228     <span class="keywordflow">return</span> totalStateProb;
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ad405e3fac20997043e0236b751e44270">01231</a> <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="QuEST__internal_8h.html#ad405e3fac20997043e0236b751e44270">densmatr_calcProbOfOutcome</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> measureQubit, <span class="keywordtype">int</span> outcome) {
<a name="l01232"></a>01232         
<a name="l01233"></a>01233         <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> zeroProb = <a class="code" href="QuEST__cpu_8c.html#a101e7ef38c5d654a697dafe14562dcee">densmatr_findProbabilityOfZeroLocal</a>(qureg, measureQubit);
<a name="l01234"></a>01234         
<a name="l01235"></a>01235         <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> outcomeProb;
<a name="l01236"></a>01236         MPI_Allreduce(&amp;zeroProb, &amp;outcomeProb, 1, MPI_QuEST_REAL, MPI_SUM, MPI_COMM_WORLD);
<a name="l01237"></a>01237         <span class="keywordflow">if</span> (outcome == 1)
<a name="l01238"></a>01238                 outcomeProb = 1.0 - outcomeProb;
<a name="l01239"></a>01239         
<a name="l01240"></a>01240         <span class="keywordflow">return</span> outcomeProb;
<a name="l01241"></a>01241 }
<a name="l01242"></a>01242 
<a name="l01243"></a><a class="code" href="QuEST__cpu__distributed_8c.html#ae45eefa65f4ecd37bab84fade7cf7f1f">01243</a> <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> <a class="code" href="QuEST__internal_8h.html#ae45eefa65f4ecd37bab84fade7cf7f1f" title="Computes the trace of the density matrix squared.">densmatr_calcPurity</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg) {
<a name="l01244"></a>01244     
<a name="l01245"></a>01245     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> localPurity = <a class="code" href="QuEST__cpu_8c.html#af910c7cf2b85bdc2c399cfe8dbfb8b9c">densmatr_calcPurityLocal</a>(qureg);
<a name="l01246"></a>01246         
<a name="l01247"></a>01247     <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> globalPurity;
<a name="l01248"></a>01248     MPI_Allreduce(&amp;localPurity, &amp;globalPurity, 1, MPI_QuEST_REAL, MPI_SUM, MPI_COMM_WORLD);
<a name="l01249"></a>01249     
<a name="l01250"></a>01250     <span class="keywordflow">return</span> globalPurity;
<a name="l01251"></a>01251 }
<a name="l01252"></a>01252 
<a name="l01253"></a><a class="code" href="QuEST__cpu__distributed_8c.html#a331b41393c22820e621628bb5e60a8b2">01253</a> <span class="keywordtype">void</span> <a class="code" href="QuEST__internal_8h.html#ae7f25bb40734e18a992403b17355893b">statevec_collapseToKnownProbOutcome</a>(<a class="code" href="structQureg.html" title="Represents a system of qubits.">Qureg</a> qureg, <span class="keyword">const</span> <span class="keywordtype">int</span> measureQubit, <span class="keywordtype">int</span> outcome, <a class="code" href="QuEST__precision_8h.html#a7740e349b4f8bae6451547680f0ce2d6" title="A precision-agnostic floating point number, as determined by QuEST_PREC.">qreal</a> totalStateProb)
<a name="l01254"></a>01254 {
<a name="l01255"></a>01255     <span class="keywordtype">int</span> skipValuesWithinRank = <a class="code" href="QuEST__cpu__distributed_8c.html#a4d043bb0cee54a5f94faf3ffc34a6790" title="return whether the current qubit rotation will use blocks that fit within a single...">halfMatrixBlockFitsInChunk</a>(qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, measureQubit);
<a name="l01256"></a>01256     <span class="keywordflow">if</span> (skipValuesWithinRank) {
<a name="l01257"></a>01257         <a class="code" href="QuEST__cpu_8c.html#ab02bce0ebbb8f624e8ced8b09b99cdef" title="Update the state vector to be consistent with measuring measureQubit=0 if outcome=0...">statevec_collapseToKnownProbOutcomeLocal</a>(qureg, measureQubit, outcome, totalStateProb);
<a name="l01258"></a>01258     } <span class="keywordflow">else</span> {
<a name="l01259"></a>01259         <span class="keywordflow">if</span> (!<a class="code" href="QuEST__cpu__distributed_8c.html#af0ea25f00987af4c53f17c9cca62ab41" title="Find chunks to skip when calculating probability of qubit being zero.">isChunkToSkipInFindPZero</a>(qureg.<a class="code" href="structQureg.html#ac2929e681d3d95591c18cf168dbbe4f0" title="The position of the chunk of the state vector held by this process in the full state...">chunkId</a>, qureg.<a class="code" href="structQureg.html#ab0ea0358482b62f43fdd781469607d97" title="Number of probability amplitudes held in stateVec by this process In the non-MPI...">numAmpsPerChunk</a>, measureQubit)){
<a name="l01260"></a>01260             <span class="comment">// chunk has amps for q=0</span>
<a name="l01261"></a>01261             <span class="keywordflow">if</span> (outcome==0) <a class="code" href="QuEST__cpu_8c.html#acd82c94cfac89eacb901348ff0d06af8" title="Renormalise parts of the state vector where measureQubit=0 or 1, based on the total...">statevec_collapseToKnownProbOutcomeDistributedRenorm</a>(qureg, measureQubit, 
<a name="l01262"></a>01262                     totalStateProb);
<a name="l01263"></a>01263             <span class="keywordflow">else</span> <a class="code" href="QuEST__cpu_8c.html#a7ea68e9132ed9db9c242353a33dba2f0" title="Set all amplitudes in one chunk to 0.">statevec_collapseToOutcomeDistributedSetZero</a>(qureg);
<a name="l01264"></a>01264         } <span class="keywordflow">else</span> {
<a name="l01265"></a>01265             <span class="comment">// chunk has amps for q=1</span>
<a name="l01266"></a>01266             <span class="keywordflow">if</span> (outcome==1) <a class="code" href="QuEST__cpu_8c.html#acd82c94cfac89eacb901348ff0d06af8" title="Renormalise parts of the state vector where measureQubit=0 or 1, based on the total...">statevec_collapseToKnownProbOutcomeDistributedRenorm</a>(qureg, measureQubit, 
<a name="l01267"></a>01267                     totalStateProb);
<a name="l01268"></a>01268             <span class="keywordflow">else</span> <a class="code" href="QuEST__cpu_8c.html#a7ea68e9132ed9db9c242353a33dba2f0" title="Set all amplitudes in one chunk to 0.">statevec_collapseToOutcomeDistributedSetZero</a>(qureg);
<a name="l01269"></a>01269         }
<a name="l01270"></a>01270     }
<a name="l01271"></a>01271 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 11 Jan 2019 for Quantum Exact Simulation Toolkit by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
